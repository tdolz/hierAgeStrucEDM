---
title: "comparison of simulations"
author: "tara dolan"
date: "5/2/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This document was created to compare the "old way" of doing the simulations - prior to April 2022 - and the "new way" post April 2022. 

**install packages**
```{r, echo=FALSE}
source("analysis_functions.R")
#devtools::install_github("tanyalrogers/GPEDM")
library(dplyr)
library(tidyverse)
library(purrr)
library(ggplot2)
library(rEDM)
library(GPEDM)
library(Metrics)
library(corrplot)
library(pracma)
library(parallel)
library(grid)
library(gridExtra)
library(cowplot)
```

**Simulation I- Old way**
the recruitment noise is very low. sdrec parameter = 0.1, recnoise is a random draw from a normal dist with an sd =0.2. Not much variation between runs. 
```{r}
set.seed(4649)
# original parameter values# 

maxiter = 500.
preylist<-list()
predlist<-list()
count0peaks <-list()
recnoise <-matrix(nrow=maxiter, ncol=5)
colnames(recnoise)<-c("recnoise","meanpeaks","varprey","meanPeriod","sdperiod")


for (m in 1:maxiter){
 
 ### The simulation (scenario 5) ########
 ### RECRUITMENT OPTIONS ####
 #ricker system param
 r = 1/1000
 sdrec= 0.1
 recnoise1 =  rnorm(1,0,0.2)
 ########
 Am = 20 # max age
 t = 500 # num time steps
 ages = 1:Am
 nsurv=0.8^(ages-1)
 N0 = 1000
 pop2=matrix(nrow=Am, ncol=t) #matrix of 10 ages (columns) and 500 time steps (rows)
 pop2[,1]=N0*nsurv #populate first time step (column)
 s = 0.8 #constant survival
 fec =  c(0,0,0,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100) #constant fecundity after maturation at age 3.
 
 for (i in 1:t-1){ #columns
  if (i == 1) {
   next
  }
  for(j in 1:Am){ #rows
   if (j==1) {
    E <-sum(fec*pop2[,i-1])
    #E <-sum(pop2[,i-1])
    pop2[j,i]=E*exp(r*(1-E))*exp(sdrec*recnoise1)
   }
   else{
    pop2[j,i]=s*pop2[j-1,i-1]
   }
  }
 }
 
 prey <-as.data.frame(t(pop2)) %>% rownames_to_column(var="time_step") %>%
  mutate(time_step=as.numeric(time_step)); 
 preypiv <-pivot_longer(prey, 2:21, names_to = "age_class")
 
 #measure how many peaks in a ten year time period.
 countpeaks <-preypiv %>%filter(time_step > 299 & time_step < 310)%>%
  dplyr::select(-time_step)%>% group_by(age_class)%>%summarize(pks = count_peaks(value))
 count0peaks[[m]] <-sum(countpeaks$pks==0)
 
 #outputs
 groupmeans <-preypiv %>% group_by(age_class)%>%summarize(preymeans=mean(value))
 mgroups <-min(groupmeans$preymeans)
 preyvar <-preypiv %>%group_by(age_class)%>%summarize(varprey=var(value))
 
 #mean period
 meanper <-preypiv %>%filter(time_step > 299 & !is.na(value))%>%
  dplyr::select(-time_step)%>% group_by(age_class)%>%summarize(periodt=period(value))
 
 recnoise[m,1]<- recnoise1
 recnoise[m,2]<-mean(countpeaks$pks)
 recnoise[m,3]<-mean(preyvar$varprey)
 recnoise[m,4]<-mean(meanper$periodt)
 recnoise[m,5]<-sd(meanper$periodt)
 
 
 if(sum(countpeaks$pks==0)< 15) { #we can't get them all in there unfortunately. 
  preylist[[m]] <- prey
 }else
  preylist[[m]] <- NA
 
 
 
}

preylist <-preylist[!is.na(preylist)] #remove all NA elements
length(preylist)
preylist <-preylist[!sapply(preylist,is.null)] #remove all null elements
length(preylist)
preylist <-preylist[1:100] #make sure it's 100 units long

#some data formatting
preylists <-preylist %>% map(~as_tibble(.)) %>% bind_rows(.id="index")%>%as.data.frame()
preypiv <- preylists%>%pivot_longer(3:22, names_to = 'age_class')
preypiv$age_class = fct_relevel(preypiv$age_class, c("V1","V2","V3","V4","V5","V6","V7","V8",                                                     "V9","V10","V11","V12","V13","V14","V15","V16","V17","V18","V19","V20"))
preypiv$age_class = fct_recode(preypiv$age_class, "age 1"="V1","age 2"="V2","age 3"="V3","age 4"="V4","age 5"="V5","age 6"="V6", "age 7"="V7", "age 8"="V8","age 9"="V9","age 10"="V10","age 11"="V11","age 12"="V12","age 13"="V13", "age 14"="V14",'age 15'='V15',"age 16"='V16','age 17'= "V17",'age 18'="V18","age 19"="V19","age 20"="V20")

```
500 runs out of 500 were viable (did not crash)


**Simulation I- Old version - mean period (years)**
```{r}
## create separate dataframe of preylist and the recruitment noise parameters and save separately. 
recnoises <-as.data.frame(recnoise)%>%rownames_to_column(var="index")
recnoises$count0peaks <-unlist(count0peaks)

#what is the period?
mean(recnoises$meanPeriod, na.rm=T)
sd(recnoises$meanPeriod, na.rm=T)
median(recnoises$meanPeriod, na.rm=T)
```
mean period: ~12.8 years +- 0.034 years. This is acceptable. 

**Simulation I - Old version - first run view**
```{r}
preylists <-preylist %>% map(~as_tibble(.)) %>% bind_rows(.id="index")%>%as.data.frame()

##visualize the data to make sure it's ok. 
preylist.mean <-preypiv%>%group_by(time_step,age_class)%>%summarize(mean.value=mean(value),.groups='drop')

preylist.mean%>%
 filter(time_step >= 300 & time_step <=400)%>%
 ggplot(aes(time_step,mean.value))+
 geom_line()+
 #geom_point(size=0.5)+
 facet_wrap(~age_class,scales="free")+
  ggtitle("mean after burn in")+
 theme_classic()

preypiv%>%
  filter(index==1)%>%
  filter(time_step >= 300 & time_step <=400)%>%
 ggplot(aes(time_step,value))+
 geom_line()+
 facet_wrap(~age_class,scales="free")+
  ggtitle("first run after burn in")+
 theme_classic()
```

So we see that it looks clean as a mean, looks clean taking a random run


**Simulation I - old way, plot each age by previous year**
```{r}
#grob plot of each age by itself the previous year.  
agelist <-unique(preypiv$age_class)
plotlist <-list()
for (i in 2:length(agelist)){
  
  df <-preypiv%>%
  filter(time_step >= 299 & time_step <=401)%>%
  filter(age_class==agelist[i] | age_class==agelist[i-1])%>%
    pivot_wider(id_cols=1:2, names_from = age_class, values_from = value)
  
  prev_yrcls_lag=lag(df[,3],1)
  df<-as.data.frame(cbind(df,prev_yrcls_lag))
  names(df)<-c("index","time_step","yrcls","yrPlus1","yrlag")
  df <-dplyr::select(df, -yrcls)%>%filter(time_step >= 300 & time_step <=400)
  
  p <-ggplot(df,aes(yrlag,yrPlus1, color=as.factor(index)))+
  geom_line()+
  ylab(paste(agelist[i],"(t)"))+xlab(paste(agelist[i-1], "(t-1)"))+
    guides(color="none")+
  theme_classic()
 
  plotlist[[i]]<-p
}
plotlist<-plotlist[2:20]
#plotlist

row1 <-plot_grid(plotlist[[1]],plotlist[[2]],plotlist[[3]],plotlist[[4]],plotlist[[5]],ncol=5)
row2 <-plot_grid(plotlist[[6]],plotlist[[7]],plotlist[[8]],plotlist[[9]],plotlist[[10]],ncol=5)
row3 <-plot_grid(plotlist[[11]],plotlist[[12]],plotlist[[13]],plotlist[[14]],plotlist[[15]],ncol=5)
row4 <-plot_grid(plotlist[[16]],plotlist[[17]],plotlist[[18]],plotlist[[19]],ncol=5)

y.grob <-textGrob("Year Class (t)", gp=gpar(fontface="bold",col="black",fontsize=12),rot=90)
x.grob <-textGrob("Prev Year Class (t-1)", gp=gpar(fontface="bold",col="black",fontsize=12))
top.grob <-textGrob("Year class vs. itself", gp=gpar(fontface="bold",col="black",fontsize=12))

mainplot <-plot_grid(row1,row2,row3,row4, nrow=4)
grid.arrange(arrangeGrob(mainplot, left=y.grob, bottom=x.grob,top=top.grob, padding=unit(0,"line")))

####NO LAG###
#grob plot of each age by itself the previous year.  
agelist <-unique(preypiv$age_class)
plotlist <-list()
for (i in 2:length(agelist)){
  
  df <-preypiv%>%
  filter(time_step >= 300 & time_step <=400)%>%
  filter(age_class==agelist[i] | age_class==agelist[i-1])%>%
    pivot_wider(id_cols=1:2, names_from = age_class, values_from = value)
  names(df)<-c("index","time_step","yrcls","yrPlus1")

  p <-ggplot(df,aes(yrcls,yrPlus1, color=as.factor(index)))+
  geom_line()+
  ylab(paste(agelist[i],"(t)"))+xlab(paste(agelist[i-1], "(t)"))+
    guides(color="none")+
  theme_classic()
 
  plotlist[[i]]<-p
}
plotlist<-plotlist[2:20]
#plotlist

row1 <-plot_grid(plotlist[[1]],plotlist[[2]],plotlist[[3]],plotlist[[4]],plotlist[[5]],ncol=5)
row2 <-plot_grid(plotlist[[6]],plotlist[[7]],plotlist[[8]],plotlist[[9]],plotlist[[10]],ncol=5)
row3 <-plot_grid(plotlist[[11]],plotlist[[12]],plotlist[[13]],plotlist[[14]],plotlist[[15]],ncol=5)
row4 <-plot_grid(plotlist[[16]],plotlist[[17]],plotlist[[18]],plotlist[[19]],ncol=5)

y.grob <-textGrob("age i (t)", gp=gpar(fontface="bold",col="black",fontsize=12),rot=90)
x.grob <-textGrob("age i-1 (t)", gp=gpar(fontface="bold",col="black",fontsize=12))
top.grob <-textGrob("age vs previous age", gp=gpar(fontface="bold",col="black",fontsize=12))

mainplot <-plot_grid(row1,row2,row3,row4, nrow=4)
grid.arrange(arrangeGrob(mainplot, left=y.grob, bottom=x.grob,top=top.grob, padding=unit(0,"line")))

```

**Simulation I-New Params**
the recruitment noise is very low. sdrec parameter increased from 0.1 to 1,  recnoise is a random draw from a normal dist with an sd that has been increased from 0.2 to 1. We played with adding a governor to reject runs with the period that was too long but ultimately rejected that.  
```{r}
set.seed(4649)
maxiter = 1000. #try making 200 of them and deleting all the zero peak one
preylist<-list()
predlist<-list()
count0peaks <-list()
recnoise <-matrix(nrow=maxiter, ncol=5)
colnames(recnoise)<-c("recnoise","meanpeaks","varprey","meanPeriod","sdperiod")


for (m in 1:maxiter){
  
  tryCatch({
    
    ### The simulation (scenario 5) ########
    ### RECRUITMENT OPTIONS ####
    #ricker system param
    r = 1/1000
    sdrec= 1 #increased
    recnoise1 =  rnorm(1,0,1) #increased SD
    ########
    Am = 20 # max age
    t = 500 # num time steps
    ages = 1:Am
    nsurv=0.8^(ages-1)
    N0 = 1000
    pop2=matrix(nrow=Am, ncol=t) #matrix of 10 ages (columns) and 500 time steps (rows)
    pop2[,1]=N0*nsurv #populate first time step (column)
    s = 0.8 #constant survival
    fec =  c(0,0,0,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100) #constant fecundity after maturation at age 3.
    
    for (i in 1:t-1){ #columns
      if (i == 1) {
        next
      }
      for(j in 1:Am){ #rows
        if (j==1) {
          E <-sum(fec*pop2[,i-1])
          #E <-sum(pop2[,i-1])
          pop2[j,i]=E*exp(r*(1-E))*exp(sdrec*recnoise1)
        }
        else{
          pop2[j,i]=s*pop2[j-1,i-1]
        }
      }
    }
    
    prey <-as.data.frame(t(pop2)) %>% rownames_to_column(var="time_step") %>%
      mutate(time_step=as.numeric(time_step)); 
    preypiv <-pivot_longer(prey, 2:21, names_to = "age_class")
    
    #measure how many peaks in a ten year time period.
    countpeaks <-preypiv %>%filter(time_step > 299 & time_step < 310)%>%
      dplyr::select(-time_step)%>% group_by(age_class)%>%summarize(pks = count_peaks(value))
    count0peaks[[m]] <-sum(countpeaks$pks==0)
    
    #outputs
    groupmeans <-preypiv %>% group_by(age_class)%>%summarize(preymeans=mean(value))
    mgroups <-min(groupmeans$preymeans)
    preyvar <-preypiv %>%group_by(age_class)%>%summarize(varprey=var(value))
    
    #mean period
    meanper <-preypiv %>%filter(time_step > 299 & !is.na(value))%>%
      dplyr::select(-time_step)%>% group_by(age_class)%>%summarize(periodt=period(value))
    
    recnoise[m,1]<- recnoise1
    recnoise[m,2]<-mean(countpeaks$pks)
    recnoise[m,3]<-mean(preyvar$varprey)
    recnoise[m,4]<-mean(meanper$periodt)
    recnoise[m,5]<-sd(meanper$periodt)
    
    
    #if(mean(meanper$periodt)<10) { #we can't get them all in there unfortunately. 
      preylist[[m]] <- prey
   # }else
    #  preylist[[m]] <- NA
    
  }, error=function(e){})
  
}

preylist <-preylist[!is.na(preylist)] #remove all NA elements
length(preylist)
preylist <-preylist[!sapply(preylist,is.null)] #remove all null elements
length(preylist)
preylist <-preylist[1:100] #make sure it's 100 units long

#some data formatting
preylists <-preylist %>% map(~as_tibble(.)) %>% bind_rows(.id="index")%>%as.data.frame()
preypiv <- preylists%>%pivot_longer(3:22, names_to = 'age_class')
preypiv$age_class = fct_relevel(preypiv$age_class, c("V1","V2","V3","V4","V5","V6","V7","V8",                                                     "V9","V10","V11","V12","V13","V14","V15","V16","V17","V18","V19","V20"))
preypiv$age_class = fct_recode(preypiv$age_class, "age 1"="V1","age 2"="V2","age 3"="V3","age 4"="V4","age 5"="V5","age 6"="V6", "age 7"="V7", "age 8"="V8","age 9"="V9","age 10"="V10","age 11"="V11","age 12"="V12","age 13"="V13", "age 14"="V14",'age 15'='V15',"age 16"='V16','age 17'= "V17",'age 18'="V18","age 19"="V19","age 20"="V20")

```
weirdly only one of the simulation runs did not work

**Simulation I- New version - mean period (years)**
```{r}
## create separate dataframe of preylist and the recruitment noise parameters and save separately. 
recnoises <-as.data.frame(recnoise)%>%rownames_to_column(var="index")
recnoises$count0peaks <-unlist(count0peaks)

#what is the period?
mean(recnoises$meanPeriod, na.rm=T)
sd(recnoises$meanPeriod, na.rm=T)
median(recnoises$meanPeriod, na.rm=T)
```
the period is 13.2 years a full year longer than the old verion, and the sd on the period is larger, which is to be expeceted from the parameter changes. 

**Simulation I - New version - first run view**
```{r}
preylists <-preylist %>% map(~as_tibble(.)) %>% bind_rows(.id="index")%>%as.data.frame()

##visualize the data to make sure it's ok. 
preylist.mean <-preypiv%>%group_by(time_step,age_class)%>%summarize(mean.value=mean(value),.groups='drop')

preylist.mean%>%
 filter(time_step >= 300 & time_step <=400)%>%
 ggplot(aes(time_step,mean.value))+
 geom_line()+
 #geom_point(size=0.5)+
 facet_wrap(~age_class,scales="free")+
  ggtitle("mean after burn in")+
 theme_classic()

preypiv%>%
  filter(index==1)%>%
  filter(time_step >= 300 & time_step <=400)%>%
 ggplot(aes(time_step,value))+
 geom_line()+
 facet_wrap(~age_class,scales="free")+
  ggtitle("first run after burn in")+
 theme_classic()
```
The mean run looks more jagged because there is more variation. The random run looks just as clean. 

**Simulation I - new way, plot each age by previous year**
```{r}
#grob plot of each age by itself the previous year.  
agelist <-unique(preypiv$age_class)
plotlist <-list()
for (i in 2:length(agelist)){
  
  df <-preypiv%>%
  filter(time_step >= 299 & time_step <=401)%>%
  filter(age_class==agelist[i] | age_class==agelist[i-1])%>%
    pivot_wider(id_cols=1:2, names_from = age_class, values_from = value)
  
  prev_yrcls_lag=lag(df[,3],1)
  df<-as.data.frame(cbind(df,prev_yrcls_lag))
  names(df)<-c("index","time_step","yrcls","yrPlus1","yrlag")
  df <-dplyr::select(df, -yrcls)%>%filter(time_step >= 300 & time_step <=400)
  
  p <-ggplot(df,aes(yrlag,yrPlus1, color=as.factor(index)))+
  geom_line()+
  ylab(paste(agelist[i],"(t)"))+xlab(paste(agelist[i-1], "(t-1)"))+
    guides(color="none")+
  theme_classic()
 
  plotlist[[i]]<-p
}
plotlist<-plotlist[2:20]
#plotlist

row1 <-plot_grid(plotlist[[1]],plotlist[[2]],plotlist[[3]],plotlist[[4]],plotlist[[5]],ncol=5)
row2 <-plot_grid(plotlist[[6]],plotlist[[7]],plotlist[[8]],plotlist[[9]],plotlist[[10]],ncol=5)
row3 <-plot_grid(plotlist[[11]],plotlist[[12]],plotlist[[13]],plotlist[[14]],plotlist[[15]],ncol=5)
row4 <-plot_grid(plotlist[[16]],plotlist[[17]],plotlist[[18]],plotlist[[19]],ncol=5)

y.grob <-textGrob("Year Class (t)", gp=gpar(fontface="bold",col="black",fontsize=12),rot=90)
x.grob <-textGrob("Prev Year Class (t-1)", gp=gpar(fontface="bold",col="black",fontsize=12))
top.grob <-textGrob("Year class vs. itself", gp=gpar(fontface="bold",col="black",fontsize=12))

mainplot <-plot_grid(row1,row2,row3,row4, nrow=4)
grid.arrange(arrangeGrob(mainplot, left=y.grob, bottom=x.grob,top=top.grob, padding=unit(0,"line")))

####NO LAG###
#grob plot of each age by itself the previous year.  
agelist <-unique(preypiv$age_class)
plotlist <-list()
for (i in 2:length(agelist)){
  
  df <-preypiv%>%
  filter(time_step >= 300 & time_step <=400)%>%
  filter(age_class==agelist[i] | age_class==agelist[i-1])%>%
    pivot_wider(id_cols=1:2, names_from = age_class, values_from = value)
  names(df)<-c("index","time_step","yrcls","yrPlus1")

  p <-ggplot(df,aes(yrcls,yrPlus1, color=as.factor(index)))+
  geom_line()+
  ylab(paste(agelist[i],"(t)"))+xlab(paste(agelist[i-1], "(t)"))+
    guides(color="none")+
  theme_classic()
 
  plotlist[[i]]<-p
}
plotlist<-plotlist[2:20]
#plotlist

row1 <-plot_grid(plotlist[[1]],plotlist[[2]],plotlist[[3]],plotlist[[4]],plotlist[[5]],ncol=5)
row2 <-plot_grid(plotlist[[6]],plotlist[[7]],plotlist[[8]],plotlist[[9]],plotlist[[10]],ncol=5)
row3 <-plot_grid(plotlist[[11]],plotlist[[12]],plotlist[[13]],plotlist[[14]],plotlist[[15]],ncol=5)
row4 <-plot_grid(plotlist[[16]],plotlist[[17]],plotlist[[18]],plotlist[[19]],ncol=5)

y.grob <-textGrob("age i (t)", gp=gpar(fontface="bold",col="black",fontsize=12),rot=90)
x.grob <-textGrob("age i-1 (t)", gp=gpar(fontface="bold",col="black",fontsize=12))
top.grob <-textGrob("age vs previous age", gp=gpar(fontface="bold",col="black",fontsize=12))

mainplot <-plot_grid(row1,row2,row3,row4, nrow=4)
grid.arrange(arrangeGrob(mainplot, left=y.grob, bottom=x.grob,top=top.grob, padding=unit(0,"line")))

```
definitely not a pure linear trend.

**SIMULATION II - OLD PARAMETERS**
low recruitment. Sdrec=0.01, where recruitment noise is drawn from a normal with an sd of 0.2, so low variation between runs. There is a governor to limit period on this. 
```{r}
set.seed(4649)
maxiter = 150. #try making 200 of them and deleting all the zero peak one.s 
preylist<-list()
predlist<-list()
count0peaks <-list()
recnoise <-matrix(nrow=maxiter, ncol=6)
colnames(recnoise)<-c("recnoise1","recnoise2","meanpeaks","varprey","meanPeriod","sdperiod")


for (m in 1:maxiter){
  
  ### The simulation (scenario 5) ########
  ### RECRUITMENT OPTIONS ####
  #Species 1 - Prey
  phi1 = 1/1000
  sdrec1 = .01  
  recnoise1 = rnorm(1,0,0.2)
  beta1 =0.002
  basefec1=c(0,0,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100) # prey
  BM1 = 2 #basefec modifier
  
  #Species 2 - Predator
  phi2 = 1/100
  sdrec2 = .01 
  recnoise2 = rnorm(1,0,0.2)
  beta2 = 0.001
  basefec2=c(0,0,0,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10)
  BM2 = 1 #basefec modifier 2 is good
  s = 0.8 #constant survival
  
  # constants common to both species (for now)#
  t = 500 # num time steps
  N01 = 1000 #initial prey #1000 is good
  N02 = N01/10 #initial pred N0/10 is good. 
  Am = 21
  ages = seq(1,Am,1)
  nsurv=0.8^(ages-1) #both species start out with the same age structure. 
  
  #make two population matrices
  pop1=matrix(nrow=Am, ncol=t) #matrix of 11 ages (columns) and 500 time steps (rows)
  pop2=matrix(nrow=Am, ncol=t)
  pop1[,1]=N01*nsurv #populate first time step (column) for species 1
  pop2[,1]=N02*nsurv #populate the first time step for species 2
  
  
  ### TIME LOOP ####
  for (i in 1:t-1){ #columns
    if (i == 1) { #skip the first time step (column) because it is already populated.
      next
    }
    ####RECRUITMENT#####
    ####
    for(j in 1:Am){
      if (j == 1) {
        pop1[j,i]=sum(pop1[,i-1]*basefec1)*exp(-phi1*sum(pop1[,i-1]*basefec1)-beta1*sum(pop2[,i-1]))*exp(sdrec1*recnoise1)
        pop2[j,i]=sum(pop2[,i-1]*basefec2)*exp(-phi2*sum(pop2[,i-1]*basefec2)-beta2*sum(pop1[,i-1]))*exp(sdrec2*recnoise2) 
        ###SURVIVAL###
        ###plus group survival
      }else if (j == Am){  #survival in the plus group
        pop1[j,i]=pop1[j-1,i-1]*exp(-sum(pop2[,i-1])/(sum(pop2[,i-1])+sum(pop1[,i-1])))+
          pop1[j,i-1]*exp(-sum(pop2[,i-1])/(sum(pop2[,i-1])+sum(pop1[,i-1])))
        pop2[j,i]=pop2[j-1,i-1]*s
      }
      #regular survival   
      else{
        pop1[j,i]=pop1[j-1,i-1]*exp(-sum(pop2[,i-1])/(sum(pop2[,i-1])+sum(pop1[,i-1])))
        pop2[j,i]=pop2[j-1,i-1]*s
      }
    }
  }
  
  ### age specific ###
  prey <-as.data.frame(t(pop1)) %>% rownames_to_column(var="time_step") %>%
    mutate(time_step=as.numeric(time_step)); prey <-prey[-500,]
  preypiv <-pivot_longer(prey, 2:22, names_to = "age_class")
  pred <-as.data.frame(t(pop2)) %>% rownames_to_column(var="time_step") %>%
    mutate(time_step=as.numeric(time_step)); pred <-pred[-500,]
  predpiv <-pivot_longer(pred, 2:22, names_to = "age_class")
  
  #outputs
  groupmeans <-preypiv %>% group_by(age_class)%>%summarize(preymeans=mean(value))
  predmeans <-predpiv %>% group_by(age_class)%>%summarize(predmeans=mean(value))
  
  mgroups <-min(groupmeans$preymeans)
  mpreds <-min(predmeans$predmeans)
  
  #count peaks
  countpeaks <-preypiv %>%filter(time_step > 299 & time_step < 310)%>%
    dplyr::select(-time_step)%>% group_by(age_class)%>%summarize(pks = count_peaks(value))
  
  
  #mean period
  meanper <-preypiv %>%filter(time_step > 299)%>%
    dplyr::select(-time_step)%>% group_by(age_class)%>%summarize(periodt=period(value))
  
  #prey variance
  preyvar <-preypiv %>%group_by(age_class)%>%summarize(varprey=var(value))
  
  #store recnoises and mean peaks
  recnoise[m,1]<-recnoise1
  recnoise[m,2]<-recnoise2
  recnoise[m,3]<-mean(countpeaks$pks)
  recnoise[m,4]<-mean(preyvar$varprey)
  recnoise[m,5]<-mean(meanper$periodt)
  recnoise[m,6]<-sd(meanper$periodt)
  
  
  #Option2#######################################
  if(sum(countpeaks$pks==0)< 8) { #we can't get them all in there unfortunately. 
    preylist[[m]] <- prey
  }else
    preylist[[m]] <- NA
  
  
}

preylist <-preylist[!is.na(preylist)] #remove all NA elements
length(preylist)
preylist <-preylist[!sapply(preylist,is.null)] #remove all null elements
length(preylist)
preylist <-preylist[1:100] #make sure it's 100 units long

#some data formatting
preylists <-preylist %>% map(~as_tibble(.)) %>% bind_rows(.id="index")%>%as.data.frame()
preypiv <- preylists%>%pivot_longer(3:23, names_to = 'age_class')
preypiv$age_class = fct_relevel(preypiv$age_class, c("V1","V2","V3","V4","V5","V6","V7","V8",                                                     "V9","V10","V11","V12","V13","V14","V15","V16","V17","V18","V19","V20"))
preypiv$age_class = fct_recode(preypiv$age_class, "age 1"="V1","age 2"="V2","age 3"="V3","age 4"="V4","age 5"="V5","age 6"="V6", "age 7"="V7", "age 8"="V8","age 9"="V9","age 10"="V10","age 11"="V11","age 12"="V12","age 13"="V13", "age 14"="V14",'age 15'='V15',"age 16"='V16','age 17'= "V17",'age 18'="V18","age 19"="V19","age 20"="V20", "age 21"="V21")

```
two out of 150 runs either crashed or were rejected for having the wrong period. 


**Simulation II- old version - mean period (years)**
```{r}
## create separate dataframe of preylist and the recruitment noise parameters and save separately. 
recnoises <-as.data.frame(recnoise)%>%rownames_to_column(var="index")
recnoises$count0peaks <-unlist(count0peaks)

#what is the period?
mean(recnoises$meanPeriod, na.rm=T)
sd(recnoises$meanPeriod, na.rm=T)
median(recnoises$meanPeriod, na.rm=T)
```
the mean period is 15 years and the sd on this is 0.0017 so very little variation. Honestly, if we can make the period shorter that would be better. 


**Simulation II - Old version - first run view**
```{r}
preylists <-preylist %>% map(~as_tibble(.)) %>% bind_rows(.id="index")%>%as.data.frame()

##visualize the data to make sure it's ok. 
preylist.mean <-preypiv%>%group_by(time_step,age_class)%>%summarize(mean.value=mean(value),.groups='drop')

preylist.mean%>%
 filter(time_step >= 300 & time_step <=400)%>%
 ggplot(aes(time_step,mean.value))+
 geom_line()+
 #geom_point(size=0.5)+
 facet_wrap(~age_class,scales="free")+
  ggtitle("mean after burn in")+
 theme_classic()

preypiv%>%
  filter(index==1)%>%
  filter(time_step >= 300 & time_step <=400)%>%
 ggplot(aes(time_step,value))+
 geom_line()+
 facet_wrap(~age_class,scales="free")+
  ggtitle("first run after burn in")+
 theme_classic()
```
look how spikey these are. Long periods of almost nothing and then sharp, high peaks. I would think depending on which 5 year segment you pick, the predictability would be very low. 

**Simulation II - OLD way, plot each age by previous year**
```{r}
#grob plot of each age by itself the previous year.  
agelist <-unique(preypiv$age_class)
plotlist <-list()
for (i in 2:length(agelist)){
  
  df <-preypiv%>%
  filter(time_step >= 299 & time_step <=401)%>%
  filter(age_class==agelist[i] | age_class==agelist[i-1])%>%
    pivot_wider(id_cols=1:2, names_from = age_class, values_from = value)
  
  prev_yrcls_lag=lag(df[,3],1)
  df<-as.data.frame(cbind(df,prev_yrcls_lag))
  names(df)<-c("index","time_step","yrcls","yrPlus1","yrlag")
  df <-dplyr::select(df, -yrcls)%>%filter(time_step >= 300 & time_step <=400)
  
  p <-ggplot(df,aes(yrlag,yrPlus1, color=as.factor(index)))+
  geom_line()+
  ylab(paste(agelist[i],"(t)"))+xlab(paste(agelist[i-1], "(t-1)"))+
    guides(color="none")+
  theme_classic()
 
  plotlist[[i]]<-p
}
plotlist<-plotlist[2:20]
#plotlist

row1 <-plot_grid(plotlist[[1]],plotlist[[2]],plotlist[[3]],plotlist[[4]],plotlist[[5]],ncol=5)
row2 <-plot_grid(plotlist[[6]],plotlist[[7]],plotlist[[8]],plotlist[[9]],plotlist[[10]],ncol=5)
row3 <-plot_grid(plotlist[[11]],plotlist[[12]],plotlist[[13]],plotlist[[14]],plotlist[[15]],ncol=5)
row4 <-plot_grid(plotlist[[16]],plotlist[[17]],plotlist[[18]],plotlist[[19]],ncol=5)

y.grob <-textGrob("Year Class (t)", gp=gpar(fontface="bold",col="black",fontsize=12),rot=90)
x.grob <-textGrob("Prev Year Class (t-1)", gp=gpar(fontface="bold",col="black",fontsize=12))
top.grob <-textGrob("Year class vs. itself", gp=gpar(fontface="bold",col="black",fontsize=12))

mainplot <-plot_grid(row1,row2,row3,row4, nrow=4)
grid.arrange(arrangeGrob(mainplot, left=y.grob, bottom=x.grob,top=top.grob, padding=unit(0,"line")))

####NO LAG###
#grob plot of each age by itself the previous year.  
agelist <-unique(preypiv$age_class)
plotlist <-list()
for (i in 2:length(agelist)){
  
  df <-preypiv%>%
  filter(time_step >= 300 & time_step <=400)%>%
  filter(age_class==agelist[i] | age_class==agelist[i-1])%>%
    pivot_wider(id_cols=1:2, names_from = age_class, values_from = value)
  names(df)<-c("index","time_step","yrcls","yrPlus1")

  p <-ggplot(df,aes(yrcls,yrPlus1, color=as.factor(index)))+
  geom_line()+
  ylab(paste(agelist[i],"(t)"))+xlab(paste(agelist[i-1], "(t)"))+
    guides(color="none")+
  theme_classic()
 
  plotlist[[i]]<-p
}
plotlist<-plotlist[2:20]
#plotlist

row1 <-plot_grid(plotlist[[1]],plotlist[[2]],plotlist[[3]],plotlist[[4]],plotlist[[5]],ncol=5)
row2 <-plot_grid(plotlist[[6]],plotlist[[7]],plotlist[[8]],plotlist[[9]],plotlist[[10]],ncol=5)
row3 <-plot_grid(plotlist[[11]],plotlist[[12]],plotlist[[13]],plotlist[[14]],plotlist[[15]],ncol=5)
row4 <-plot_grid(plotlist[[16]],plotlist[[17]],plotlist[[18]],plotlist[[19]],ncol=5)

y.grob <-textGrob("age i (t)", gp=gpar(fontface="bold",col="black",fontsize=12),rot=90)
x.grob <-textGrob("age i-1 (t)", gp=gpar(fontface="bold",col="black",fontsize=12))
top.grob <-textGrob("age vs previous age", gp=gpar(fontface="bold",col="black",fontsize=12))

mainplot <-plot_grid(row1,row2,row3,row4, nrow=4)
grid.arrange(arrangeGrob(mainplot, left=y.grob, bottom=x.grob,top=top.grob, padding=unit(0,"line")))

```
I'm not exactly sure what is going on here... 

**SIMULATION II - NEW VERSION ***
sd rec has been changed to 1 and the sd of the rnorm from which rec is drawn also increased to 1. there is a governor to limit period. 
```{r}
set.seed(4649)
maxiter = 1000. 
preylist<-list()
predlist<-list()
count0peaks <-list()
recnoise <-matrix(nrow=maxiter, ncol=6)
colnames(recnoise)<-c("recnoise1","recnoise2","meanpeaks","varprey","meanPeriod","sdperiod")


for (m in 1:maxiter){
  
  tryCatch({
    
    ### The simulation (scenario 5) ########
    ### RECRUITMENT OPTIONS ####
    #Species 1 - Prey
    phi1 = 1/1000
    sdrec1 = 1  
    recnoise1 = rnorm(1,0,1)
    beta1 =0.002
    basefec1=c(0,0,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100) # prey
    BM1 = 2 #basefec modifier
    
    #Species 2 - Predator
    phi2 = 1/100
    sdrec2 = 1 
    recnoise2 = rnorm(1,0,1)
    beta2 = 0.001
    basefec2=c(0,0,0,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10)
    BM2 = 1 #basefec modifier 2 is good
    s = 0.8 #constant survival
    
    # constants common to both species (for now)#
    t = 500 # num time steps
    N01 = 1000 #initial prey #1000 is good
    N02 = N01/10 #initial pred N0/10 is good. 
    Am = 21
    ages = seq(1,Am,1)
    nsurv=0.8^(ages-1) #both species start out with the same age structure. 
    
    #make two population matrices
    pop1=matrix(nrow=Am, ncol=t) #matrix of 11 ages (columns) and 500 time steps (rows)
    pop2=matrix(nrow=Am, ncol=t)
    pop1[,1]=N01*nsurv #populate first time step (column) for species 1
    pop2[,1]=N02*nsurv #populate the first time step for species 2
    
    
    ### TIME LOOP ####
    for (i in 1:t-1){ #columns
      if (i == 1) { #skip the first time step (column) because it is already populated.
        next
      }
      ####RECRUITMENT#####
      ####
      for(j in 1:Am){
        if (j == 1) {
          pop1[j,i]=sum(pop1[,i-1]*basefec1)*exp(-phi1*sum(pop1[,i-1]*basefec1)-beta1*sum(pop2[,i-1]))*exp(sdrec1*recnoise1)
          pop2[j,i]=sum(pop2[,i-1]*basefec2)*exp(-phi2*sum(pop2[,i-1]*basefec2)-beta2*sum(pop1[,i-1]))*exp(sdrec2*recnoise2) 
          ###SURVIVAL###
          ###plus group survival
        }else if (j == Am){  #survival in the plus group
          pop1[j,i]=pop1[j-1,i-1]*exp(-sum(pop2[,i-1])/(sum(pop2[,i-1])+sum(pop1[,i-1])))+
            pop1[j,i-1]*exp(-sum(pop2[,i-1])/(sum(pop2[,i-1])+sum(pop1[,i-1])))
          pop2[j,i]=pop2[j-1,i-1]*s
        }
        #regular survival   
        else{
          pop1[j,i]=pop1[j-1,i-1]*exp(-sum(pop2[,i-1])/(sum(pop2[,i-1])+sum(pop1[,i-1])))
          pop2[j,i]=pop2[j-1,i-1]*s
        }
      }
    }
    
    ### age specific ###
    prey <-as.data.frame(t(pop1)) %>% rownames_to_column(var="time_step") %>%
      mutate(time_step=as.numeric(time_step)); prey <-prey[-500,]
    preypiv <-pivot_longer(prey, 2:22, names_to = "age_class")
    pred <-as.data.frame(t(pop2)) %>% rownames_to_column(var="time_step") %>%
      mutate(time_step=as.numeric(time_step)); pred <-pred[-500,]
    predpiv <-pivot_longer(pred, 2:22, names_to = "age_class")
    
    #outputs
    groupmeans <-preypiv %>% group_by(age_class)%>%summarize(preymeans=mean(value))
    predmeans <-predpiv %>% group_by(age_class)%>%summarize(predmeans=mean(value))
    
    mgroups <-min(groupmeans$preymeans)
    mpreds <-min(predmeans$predmeans)
    
    #count peaks
    countpeaks <-preypiv %>%filter(time_step > 299 & time_step < 310)%>%
      dplyr::select(-time_step)%>% group_by(age_class)%>%summarize(pks = count_peaks(value))
    
    
    #mean period
    meanper <-preypiv %>%filter(time_step > 299)%>%
      dplyr::select(-time_step)%>% group_by(age_class)%>%summarize(periodt=period(value))
    
    #prey variance
    preyvar <-preypiv %>%group_by(age_class)%>%summarize(varprey=var(value))
    
    #store recnoises and mean peaks
    recnoise[m,1]<-recnoise1
    recnoise[m,2]<-recnoise2
    recnoise[m,3]<-mean(countpeaks$pks)
    recnoise[m,4]<-mean(preyvar$varprey)
    recnoise[m,5]<-mean(meanper$periodt)
    recnoise[m,6]<-sd(meanper$periodt)

    
    #mean period governor
    if(mean(meanper$periodt)<10) { #we can't get them all in there unfortunately. 
      preylist[[m]] <- prey
    }else
      preylist[[m]] <- NA
    
    #no governor
    #preylist[[m]] <- prey
    
  }, error=function(e){})
  
}

preylist <-preylist[!is.na(preylist)] #remove all NA elements
length(preylist)
preylist <-preylist[!sapply(preylist,is.null)] #remove all null elements
length(preylist)
preylist <-preylist[1:100] #make sure it's 100 units long

#some data formatting
preylists <-preylist %>% map(~as_tibble(.)) %>% bind_rows(.id="index")%>%as.data.frame()
preypiv <- preylists%>%pivot_longer(3:23, names_to = 'age_class')
preypiv$age_class = fct_relevel(preypiv$age_class, c("V1","V2","V3","V4","V5","V6","V7","V8",                                                     "V9","V10","V11","V12","V13","V14","V15","V16","V17","V18","V19","V20"))
preypiv$age_class = fct_recode(preypiv$age_class, "age 1"="V1","age 2"="V2","age 3"="V3","age 4"="V4","age 5"="V5","age 6"="V6", "age 7"="V7", "age 8"="V8","age 9"="V9","age 10"="V10","age 11"="V11","age 12"="V12","age 13"="V13", "age 14"="V14",'age 15'='V15',"age 16"='V16','age 17'= "V17",'age 18'="V18","age 19"="V19","age 20"="V20", "age 21"="V21")

```
out of 1000 runs only 420 didn't crash and only 116 of those had a short enough period. 

**Simulation II- NEW version - mean period (years)**
```{r}
## create separate dataframe of preylist and the recruitment noise parameters and save separately. 
recnoises <-as.data.frame(recnoise)%>%rownames_to_column(var="index")
recnoises$count0peaks <-unlist(count0peaks)

#what is the period?
mean(recnoises$meanPeriod, na.rm=T)
sd(recnoises$meanPeriod, na.rm=T)
median(recnoises$meanPeriod, na.rm=T)
```
The period is 16 years. this is really too long, and the sd is 9 years! which is very variable. 

**Simulation II - NEW version - first run view**
```{r}
preylists <-preylist %>% map(~as_tibble(.)) %>% bind_rows(.id="index")%>%as.data.frame()

##visualize the data to make sure it's ok. 
preylist.mean <-preypiv%>%group_by(time_step,age_class)%>%summarize(mean.value=mean(value),.groups='drop')

preylist.mean%>%
 filter(time_step >= 300 & time_step <=400)%>%
 ggplot(aes(time_step,mean.value))+
 geom_line()+
 #geom_point(size=0.5)+
 facet_wrap(~age_class,scales="free")+
  ggtitle("mean after burn in")+
 theme_classic()

preypiv%>%
  filter(index==1)%>%
  filter(time_step >= 300 & time_step <=400)%>%
 ggplot(aes(time_step,value))+
 geom_line()+
 facet_wrap(~age_class,scales="free")+
  ggtitle("first run after burn in")+
 theme_classic()
```
The mean is very wiggly because of the standard deviation. But the first run is still very clean. 

**Simulation II - NEW way, plot each age by previous year**
```{r}
#grob plot of each age by itself the previous year.  
agelist <-unique(preypiv$age_class)
plotlist <-list()
for (i in 2:length(agelist)){
  
  df <-preypiv%>%
  filter(time_step >= 299 & time_step <=401)%>%
  filter(age_class==agelist[i] | age_class==agelist[i-1])%>%
    pivot_wider(id_cols=1:2, names_from = age_class, values_from = value)
  
  prev_yrcls_lag=lag(df[,3],1)
  df<-as.data.frame(cbind(df,prev_yrcls_lag))
  names(df)<-c("index","time_step","yrcls","yrPlus1","yrlag")
  df <-dplyr::select(df, -yrcls)%>%filter(time_step >= 300 & time_step <=400)
  
  p <-ggplot(df,aes(yrlag,yrPlus1, color=as.factor(index)))+
  geom_line()+
  ylab(paste(agelist[i],"(t)"))+xlab(paste(agelist[i-1], "(t-1)"))+
    guides(color="none")+
  theme_classic()
 
  plotlist[[i]]<-p
}
plotlist<-plotlist[2:20]
#plotlist

row1 <-plot_grid(plotlist[[1]],plotlist[[2]],plotlist[[3]],plotlist[[4]],plotlist[[5]],ncol=5)
row2 <-plot_grid(plotlist[[6]],plotlist[[7]],plotlist[[8]],plotlist[[9]],plotlist[[10]],ncol=5)
row3 <-plot_grid(plotlist[[11]],plotlist[[12]],plotlist[[13]],plotlist[[14]],plotlist[[15]],ncol=5)
row4 <-plot_grid(plotlist[[16]],plotlist[[17]],plotlist[[18]],plotlist[[19]],ncol=5)

y.grob <-textGrob("Year Class (t)", gp=gpar(fontface="bold",col="black",fontsize=12),rot=90)
x.grob <-textGrob("Prev Year Class (t-1)", gp=gpar(fontface="bold",col="black",fontsize=12))
top.grob <-textGrob("Year class vs. itself", gp=gpar(fontface="bold",col="black",fontsize=12))

mainplot <-plot_grid(row1,row2,row3,row4, nrow=4)
grid.arrange(arrangeGrob(mainplot, left=y.grob, bottom=x.grob,top=top.grob, padding=unit(0,"line")))

####NO LAG###
#grob plot of each age by itself the previous year.  
agelist <-unique(preypiv$age_class)
plotlist <-list()
for (i in 2:length(agelist)){
  
  df <-preypiv%>%
  filter(time_step >= 300 & time_step <=400)%>%
  filter(age_class==agelist[i] | age_class==agelist[i-1])%>%
    pivot_wider(id_cols=1:2, names_from = age_class, values_from = value)
  names(df)<-c("index","time_step","yrcls","yrPlus1")

  p <-ggplot(df,aes(yrcls,yrPlus1, color=as.factor(index)))+
  geom_line()+
  ylab(paste(agelist[i],"(t)"))+xlab(paste(agelist[i-1], "(t)"))+
    guides(color="none")+
  theme_classic()
 
  plotlist[[i]]<-p
}
plotlist<-plotlist[2:20]
#plotlist

row1 <-plot_grid(plotlist[[1]],plotlist[[2]],plotlist[[3]],plotlist[[4]],plotlist[[5]],ncol=5)
row2 <-plot_grid(plotlist[[6]],plotlist[[7]],plotlist[[8]],plotlist[[9]],plotlist[[10]],ncol=5)
row3 <-plot_grid(plotlist[[11]],plotlist[[12]],plotlist[[13]],plotlist[[14]],plotlist[[15]],ncol=5)
row4 <-plot_grid(plotlist[[16]],plotlist[[17]],plotlist[[18]],plotlist[[19]],ncol=5)

y.grob <-textGrob("age i (t)", gp=gpar(fontface="bold",col="black",fontsize=12),rot=90)
x.grob <-textGrob("age i-1 (t)", gp=gpar(fontface="bold",col="black",fontsize=12))
top.grob <-textGrob("age vs previous age", gp=gpar(fontface="bold",col="black",fontsize=12))

mainplot <-plot_grid(row1,row2,row3,row4, nrow=4)
grid.arrange(arrangeGrob(mainplot, left=y.grob, bottom=x.grob,top=top.grob, padding=unit(0,"line")))

```

It's definitely less linear. which is good!! 

**SIMULATION III OLD WAY**
very low recruitment multiplier 0.02, and the recruitment noise is a random draw from a distribution with sd=0.2 There is also a governor to limit period/ 
```{r}
set.seed(4649)
maxiter = 150. 
preylist<-list()
predlist<-list()
count0peaks <-list()
recnoise <-matrix(nrow=maxiter, ncol=6)
colnames(recnoise)<-c("recnoise1","recnoise2","meanpeaks","varprey","meanPeriod","sdperiod")


for (m in 1:maxiter){
  
  ##### RECRUITMENT OPTIONS ####
  #Species 1 - Prey
  phi1 = 1/1000
  sdrec1 = .02  
  recnoise1 =rnorm(1,0,0.2)
  qfec1 = c(0,0,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1) #prey consumption conversion efficiency (< 1)
  qfec1=qfec1*8 
  CM1 = 0.01 #modifier of the pred_eat_prey matrix 0.01
  basefec1=c(0,0,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100) # prey
  BM1 = 2 #basefec modifier
  
  #Species 2 - Predator
  phi2 = 1/100
  sdrec2 = .02 
  recnoise2=rnorm(1,0,0.2)
  qfec2 = c(0,0,0,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1) #pred consumption conversion efficiency (< 1)
  qfec2=qfec2*8 #8 is good
  CM2 = .05 #prey eat pred 0.1, 0.05 for steves pred matrix. 
  basefec2=c(0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)
  BM2 = 2 #basefec modifier 2 is good
  
  # constants common to both species (for now)#
  t = 500 # num time steps
  N01 = 1000 #initial prey #1000 is good
  N02 = N01/10 #initial pred N0/10 is good. 
  Am = 20
  ages = seq(1,Am,1)
  nsurv=0.8^(ages-1) #both species start out with the same age structure. 
  
  #make two population matrices
  pop1=matrix(nrow=Am, ncol=t) #matrix of 11 ages (columns) and 500 time steps (rows)
  pop2=matrix(nrow=Am, ncol=t)
  pop1[,1]=N01*nsurv #populate first time step (column) for species 1
  pop2[,1]=N02*nsurv #populate the first time step for species 2
  
  #fecundity matrices
  fec1=matrix(nrow=Am, ncol=t) #prey
  fec2=matrix(nrow=Am, ncol=t) #predator
  #Baseline fecundity: Populate the first column (time step) of the fecundity matrix
  fec1[,1]=basefec1
  fec2[,1]=basefec2
  
  #predators eat prey at a rate which increases with age.
  #prey never really escape predation but predation is diminished. 
  #Reverse the matrix order 
  #pred_eat_prey=read.csv("predatormatrix.csv", header=FALSE)%>%as.matrix()
  #pred_eat_prey=read.csv("stevespredatormatrix.csv", header=FALSE)%>%as.matrix()
  pred_eat_prey=read.csv("predmatrix_shortosc.csv", header=FALSE)%>%as.matrix() #the shorter oscillations. 
  colnames(pred_eat_prey)<- NULL
  #multiply by 0
  pred_eat_prey=pred_eat_prey*CM1 
  
  #prey only eat predators as eggs (for now)
  prey_eat_pred=read.csv("preymatrix.csv", header=FALSE)%>%as.matrix()
  colnames(prey_eat_pred)<- NULL
  #multiply by 0
  prey_eat_pred=prey_eat_pred*CM2
  
  ### TIME LOOP ####
  for (i in 1:t-1){ #columns
    if (i == 1) { #skip the first time step (column) because it is already populated.
      next
    }
    ### FECUNDITY
    for(j in 1:Am){  #rows
      #fecundity is the rate at which eater is eating*the thing being eaten across ages*
      fec1[j,i] = pop1[j,i-1]*(basefec1[j]+qfec1[j]*prey_eat_pred[j,]%*%pop2[,i-1]) #fecundity of prey
      fec2[j,i] = pop2[j,i-1]*(basefec2[j]+qfec2[j]*pred_eat_prey[j,]%*%pop1[,i-1]) #fecundity of pred
    }
    ####RECRUITMENT#####
    ####
    for(j in 1:Am){
      if (j == 1) {
        pop1[j,i]=sum(fec1[,i])*exp(-phi1*sum(fec1[,i]))*exp(sdrec1*recnoise1)
        pop2[j,i]=sum(fec2[,i])*exp(-phi2*sum(fec2[,i]))*exp(sdrec2*recnoise2) 
      }
      #regular survival
      else{
        pop1[j,i]=pop1[j-1,i-1]*exp(-sum(pred_eat_prey[,j-1]*pop2[,i-1]))
        pop2[j,i]=pop2[j-1,i-1]*exp(-sum(prey_eat_pred[,j-1]*pop1[,i-1]))
      }
    }
  }
  ### age specific ###
  prey <-as.data.frame(t(pop1)) %>% rownames_to_column(var="time_step") %>%
    mutate(time_step=as.numeric(time_step)); prey <-prey[-500,]
  preypiv <-pivot_longer(prey, 2:21, names_to = "age_class")
  pred <-as.data.frame(t(pop2)) %>% rownames_to_column(var="time_step") %>%
    mutate(time_step=as.numeric(time_step)); pred <-pred[-500,]
  predpiv <-pivot_longer(pred, 2:21, names_to = "age_class")
  
  #outputs
  groupmeans <-preypiv %>% group_by(age_class)%>%summarize(preymeans=mean(value))
  predmeans <-predpiv %>% group_by(age_class)%>%summarize(predmeans=mean(value))
  
  mgroups <-min(groupmeans$preymeans)
  mpreds <-min(predmeans$predmeans)
  
  #count peaks
  countpeaks <-preypiv %>%filter(time_step > 299 & time_step < 310)%>%
    dplyr::select(-time_step)%>% group_by(age_class)%>%summarize(pks = count_peaks(value))
  
  #mean period
  meanper <-preypiv %>%filter(time_step > 299)%>% #period after the burn-in period
    dplyr::select(-time_step)%>% group_by(age_class)%>%summarize(periodt=period(value))
  
  #prey variance
  preyvar <-preypiv %>%group_by(age_class)%>%summarize(varprey=var(value))
  
  #store recnoises and mean peaks
  recnoise[m,1]<-recnoise1
  recnoise[m,2]<-recnoise2
  recnoise[m,3]<-mean(countpeaks$pks)
  recnoise[m,4]<-mean(preyvar$varprey)
  recnoise[m,5]<-mean(meanper$periodt)
  recnoise[m,6]<-sd(meanper$periodt)
  
  
  #if(mgroups > 0.1 & mpreds > 0.1 & mean(countpeaks$pks) > 1.2) {
  if(mean(countpeaks$pks) > 1.2) {
    preylist[[m]] <- prey
  }else
    preylist[[m]] <- NA
}

preylist <-preylist[!is.na(preylist)] #remove all NA elements
length(preylist)
preylist <-preylist[!sapply(preylist,is.null)] #remove all null elements
length(preylist)
preylist <-preylist[1:100] #make sure it's 100 units long

#some data formatting
preylists <-preylist %>% map(~as_tibble(.)) %>% bind_rows(.id="index")%>%as.data.frame()
preypiv <- preylists%>%pivot_longer(3:22, names_to = 'age_class')
preypiv$age_class = fct_relevel(preypiv$age_class, c("V1","V2","V3","V4","V5","V6","V7","V8",                                                     "V9","V10","V11","V12","V13","V14","V15","V16","V17","V18","V19","V20"))
preypiv$age_class = fct_recode(preypiv$age_class, "age 1"="V1","age 2"="V2","age 3"="V3","age 4"="V4","age 5"="V5","age 6"="V6", "age 7"="V7", "age 8"="V8","age 9"="V9","age 10"="V10","age 11"="V11","age 12"="V12","age 13"="V13", "age 14"="V14",'age 15'='V15',"age 16"='V16','age 17'= "V17",'age 18'="V18","age 19"="V19","age 20"="V20")

```
none of the 150 iterations crashed or were thrown out because the period was too long. 

**Simulation III- OLD version - mean period (years)**
```{r}
## create separate dataframe of preylist and the recruitment noise parameters and save separately. 
recnoises <-as.data.frame(recnoise)%>%rownames_to_column(var="index")
recnoises$count0peaks <-unlist(count0peaks)

#what is the period?
mean(recnoises$meanPeriod, na.rm=T)
sd(recnoises$meanPeriod, na.rm=T)
median(recnoises$meanPeriod, na.rm=T)
```
Nice short period! very limited sd. 

**Simulation III - Old version - first run view**
```{r}
preylists <-preylist %>% map(~as_tibble(.)) %>% bind_rows(.id="index")%>%as.data.frame()

##visualize the data to make sure it's ok. 
preylist.mean <-preypiv%>%group_by(time_step,age_class)%>%summarize(mean.value=mean(value),.groups='drop')

preylist.mean%>%
 filter(time_step >= 300 & time_step <=400)%>%
 ggplot(aes(time_step,mean.value))+
 geom_line()+
 #geom_point(size=0.5)+
 facet_wrap(~age_class,scales="free")+
  ggtitle("mean after burn in")+
 theme_classic()

preypiv%>%
  filter(index==1)%>%
  filter(time_step >= 300 & time_step <=400)%>%
 ggplot(aes(time_step,value))+
 geom_line()+
 facet_wrap(~age_class,scales="free")+
  ggtitle("first run after burn in")+
 theme_classic()
```
Nice short period oscillations. 

**Simulation III - OLD way, plot each age by previous year**
```{r}
#grob plot of each age by itself the previous year.  
agelist <-unique(preypiv$age_class)
plotlist <-list()
for (i in 2:length(agelist)){
  
  df <-preypiv%>%
  filter(time_step >= 299 & time_step <=401)%>%
  filter(age_class==agelist[i] | age_class==agelist[i-1])%>%
    pivot_wider(id_cols=1:2, names_from = age_class, values_from = value)
  
  prev_yrcls_lag=lag(df[,3],1)
  df<-as.data.frame(cbind(df,prev_yrcls_lag))
  names(df)<-c("index","time_step","yrcls","yrPlus1","yrlag")
  df <-dplyr::select(df, -yrcls)%>%filter(time_step >= 300 & time_step <=400)
  
  p <-ggplot(df,aes(yrlag,yrPlus1, color=as.factor(index)))+
  geom_line()+
  ylab(paste(agelist[i],"(t)"))+xlab(paste(agelist[i-1], "(t-1)"))+
    guides(color="none")+
  theme_classic()
 
  plotlist[[i]]<-p
}
plotlist<-plotlist[2:20]
#plotlist

row1 <-plot_grid(plotlist[[1]],plotlist[[2]],plotlist[[3]],plotlist[[4]],plotlist[[5]],ncol=5)
row2 <-plot_grid(plotlist[[6]],plotlist[[7]],plotlist[[8]],plotlist[[9]],plotlist[[10]],ncol=5)
row3 <-plot_grid(plotlist[[11]],plotlist[[12]],plotlist[[13]],plotlist[[14]],plotlist[[15]],ncol=5)
row4 <-plot_grid(plotlist[[16]],plotlist[[17]],plotlist[[18]],plotlist[[19]],ncol=5)

y.grob <-textGrob("Year Class (t)", gp=gpar(fontface="bold",col="black",fontsize=12),rot=90)
x.grob <-textGrob("Prev Year Class (t-1)", gp=gpar(fontface="bold",col="black",fontsize=12))
top.grob <-textGrob("Year class vs. itself", gp=gpar(fontface="bold",col="black",fontsize=12))

mainplot <-plot_grid(row1,row2,row3,row4, nrow=4)
grid.arrange(arrangeGrob(mainplot, left=y.grob, bottom=x.grob,top=top.grob, padding=unit(0,"line")))

####NO LAG###
#grob plot of each age by itself the previous year.  
agelist <-unique(preypiv$age_class)
plotlist <-list()
for (i in 2:length(agelist)){
  
  df <-preypiv%>%
  filter(time_step >= 300 & time_step <=400)%>%
  filter(age_class==agelist[i] | age_class==agelist[i-1])%>%
    pivot_wider(id_cols=1:2, names_from = age_class, values_from = value)
  names(df)<-c("index","time_step","yrcls","yrPlus1")

  p <-ggplot(df,aes(yrcls,yrPlus1, color=as.factor(index)))+
  geom_line()+
  ylab(paste(agelist[i],"(t)"))+xlab(paste(agelist[i-1], "(t)"))+
    guides(color="none")+
  theme_classic()
 
  plotlist[[i]]<-p
}
plotlist<-plotlist[2:20]
#plotlist

row1 <-plot_grid(plotlist[[1]],plotlist[[2]],plotlist[[3]],plotlist[[4]],plotlist[[5]],ncol=5)
row2 <-plot_grid(plotlist[[6]],plotlist[[7]],plotlist[[8]],plotlist[[9]],plotlist[[10]],ncol=5)
row3 <-plot_grid(plotlist[[11]],plotlist[[12]],plotlist[[13]],plotlist[[14]],plotlist[[15]],ncol=5)
row4 <-plot_grid(plotlist[[16]],plotlist[[17]],plotlist[[18]],plotlist[[19]],ncol=5)

y.grob <-textGrob("age i (t)", gp=gpar(fontface="bold",col="black",fontsize=12),rot=90)
x.grob <-textGrob("age i-1 (t)", gp=gpar(fontface="bold",col="black",fontsize=12))
top.grob <-textGrob("age vs previous age", gp=gpar(fontface="bold",col="black",fontsize=12))

mainplot <-plot_grid(row1,row2,row3,row4, nrow=4)
grid.arrange(arrangeGrob(mainplot, left=y.grob, bottom=x.grob,top=top.grob, padding=unit(0,"line")))

```
either the year classes are slightly out of phase or they are truely nonlinear. 

**SIMULATION III NEW way**
recruitment noise multiplier increased to 1 and sd of recruitment normal draw increased to 1
```{r}
set.seed(4649)
maxiter = 1000. 
preylist<-list()
predlist<-list()
count0peaks <-list()
recnoise <-matrix(nrow=maxiter, ncol=6)
colnames(recnoise)<-c("recnoise1","recnoise2","meanpeaks","varprey","meanPeriod","sdperiod")


for (m in 1:maxiter){
  
  tryCatch({
    
    ##### RECRUITMENT OPTIONS ####
    #Species 1 - Prey
    phi1 = 1/1000
    sdrec1 = 1  
    recnoise1 =rnorm(1,0,1)
    qfec1 = c(0,0,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1) #prey consumption conversion efficiency (< 1)
    qfec1=qfec1*8 
    CM1 = 0.01 #modifier of the pred_eat_prey matrix 0.01
    basefec1=c(0,0,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100) # prey
    BM1 = 2 #basefec modifier
    
    #Species 2 - Predator
    phi2 = 1/100
    sdrec2 = 1 
    recnoise2=rnorm(1,0,1)
    qfec2 = c(0,0,0,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1) #pred consumption conversion efficiency (< 1)
    qfec2=qfec2*8 #8 is good
    CM2 = .05 #prey eat pred 0.1, 0.05 for steves pred matrix. 
    basefec2=c(0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)
    BM2 = 2 #basefec modifier 2 is good
    
    # constants common to both species (for now)#
    t = 500 # num time steps
    N01 = 1000 #initial prey #1000 is good
    N02 = N01/10 #initial pred N0/10 is good. 
    Am = 20
    ages = seq(1,Am,1)
    nsurv=0.8^(ages-1) #both species start out with the same age structure. 
    
    #make two population matrices
    pop1=matrix(nrow=Am, ncol=t) #matrix of 11 ages (columns) and 500 time steps (rows)
    pop2=matrix(nrow=Am, ncol=t)
    pop1[,1]=N01*nsurv #populate first time step (column) for species 1
    pop2[,1]=N02*nsurv #populate the first time step for species 2
    
    #fecundity matrices
    fec1=matrix(nrow=Am, ncol=t) #prey
    fec2=matrix(nrow=Am, ncol=t) #predator
    #Baseline fecundity: Populate the first column (time step) of the fecundity matrix
    fec1[,1]=basefec1
    fec2[,1]=basefec2
    
    #predators eat prey at a rate which increases with age.
    #prey never really escape predation but predation is diminished. 
    #Reverse the matrix order 
    #pred_eat_prey=read.csv("predatormatrix.csv", header=FALSE)%>%as.matrix()
    #pred_eat_prey=read.csv("stevespredatormatrix.csv", header=FALSE)%>%as.matrix()
    pred_eat_prey=read.csv("predmatrix_shortosc.csv", header=FALSE)%>%as.matrix() #the shorter oscillations. 
    colnames(pred_eat_prey)<- NULL
    #multiply by 0
    pred_eat_prey=pred_eat_prey*CM1 
    
    #prey only eat predators as eggs (for now)
    prey_eat_pred=read.csv("preymatrix.csv", header=FALSE)%>%as.matrix()
    colnames(prey_eat_pred)<- NULL
    #multiply by 0
    prey_eat_pred=prey_eat_pred*CM2
    
    ### TIME LOOP ####
    for (i in 1:t-1){ #columns
      if (i == 1) { #skip the first time step (column) because it is already populated.
        next
      }
      ### FECUNDITY
      for(j in 1:Am){  #rows
        #fecundity is the rate at which eater is eating*the thing being eaten across ages*
        fec1[j,i] = pop1[j,i-1]*(basefec1[j]+qfec1[j]*prey_eat_pred[j,]%*%pop2[,i-1]) #fecundity of prey
        fec2[j,i] = pop2[j,i-1]*(basefec2[j]+qfec2[j]*pred_eat_prey[j,]%*%pop1[,i-1]) #fecundity of pred
      }
      ####RECRUITMENT#####
      
      ####
      for(j in 1:Am){
        if (j == 1) {
          pop1[j,i]=sum(fec1[,i])*exp(-phi1*sum(fec1[,i]))*exp(sdrec1*recnoise1)
          pop2[j,i]=sum(fec2[,i])*exp(-phi2*sum(fec2[,i]))*exp(sdrec2*recnoise2) 
        }
        #regular survival
        else{
          pop1[j,i]=pop1[j-1,i-1]*exp(-sum(pred_eat_prey[,j-1]*pop2[,i-1]))
          pop2[j,i]=pop2[j-1,i-1]*exp(-sum(prey_eat_pred[,j-1]*pop1[,i-1]))
        }
      }
    }
    
    ### age specific ###
    prey <-as.data.frame(t(pop1)) %>% rownames_to_column(var="time_step") %>%
      mutate(time_step=as.numeric(time_step)); prey <-prey[-500,]
    preypiv <-pivot_longer(prey, 2:21, names_to = "age_class")
    pred <-as.data.frame(t(pop2)) %>% rownames_to_column(var="time_step") %>%
      mutate(time_step=as.numeric(time_step)); pred <-pred[-500,]
    predpiv <-pivot_longer(pred, 2:21, names_to = "age_class")
    
    #outputs
    groupmeans <-preypiv %>% group_by(age_class)%>%summarize(preymeans=mean(value))
    predmeans <-predpiv %>% group_by(age_class)%>%summarize(predmeans=mean(value))
    
    mgroups <-min(groupmeans$preymeans)
    mpreds <-min(predmeans$predmeans)
    
    #count peaks
    countpeaks <-preypiv %>%filter(time_step > 299 & time_step < 310)%>%
      dplyr::select(-time_step)%>% group_by(age_class)%>%summarize(pks = count_peaks(value))
    
    #mean period
    meanper <-preypiv %>%filter(time_step > 299)%>% #period after the burn-in period
      dplyr::select(-time_step)%>% group_by(age_class)%>%summarize(periodt=period(value))
    
    #prey variance
    preyvar <-preypiv %>%group_by(age_class)%>%summarize(varprey=var(value))
    
    #store recnoises and mean peaks
    recnoise[m,1]<-recnoise1
    recnoise[m,2]<-recnoise2
    recnoise[m,3]<-mean(countpeaks$pks)
    recnoise[m,4]<-mean(preyvar$varprey)
    recnoise[m,5]<-mean(meanper$periodt)
    recnoise[m,6]<-sd(meanper$periodt)
    
    #governor
    if(mean(meanper$periodt) < 10){
      preylist[[m]] <- prey
    }else
      preylist[[m]] <- NA
    
    
  }, error=function(e){})
  
}

preylist <-preylist[!is.na(preylist)] #remove all NA elements
length(preylist)
preylist <-preylist[!sapply(preylist,is.null)] #remove all null elements
length(preylist)
preylist <-preylist[1:100] #make sure it's 100 units long

#some data formatting
preylists <-preylist %>% map(~as_tibble(.)) %>% bind_rows(.id="index")%>%as.data.frame()
preypiv <- preylists%>%pivot_longer(3:22, names_to = 'age_class')
preypiv$age_class = fct_relevel(preypiv$age_class, c("V1","V2","V3","V4","V5","V6","V7","V8",                                                     "V9","V10","V11","V12","V13","V14","V15","V16","V17","V18","V19","V20"))
preypiv$age_class = fct_recode(preypiv$age_class, "age 1"="V1","age 2"="V2","age 3"="V3","age 4"="V4","age 5"="V5","age 6"="V6", "age 7"="V7", "age 8"="V8","age 9"="V9","age 10"="V10","age 11"="V11","age 12"="V12","age 13"="V13", "age 14"="V14",'age 15'='V15',"age 16"='V16','age 17'= "V17",'age 18'="V18","age 19"="V19","age 20"="V20")

```
of 1000 runs, 605 did not crash and 302 had a period short enough. 

**Simulation III- NEW version - mean period (years)**
```{r}
## create separate dataframe of preylist and the recruitment noise parameters and save separately. 
recnoises <-as.data.frame(recnoise)%>%rownames_to_column(var="index")
recnoises$count0peaks <-unlist(count0peaks)

#what is the period?
mean(recnoises$meanPeriod, na.rm=T)
sd(recnoises$meanPeriod, na.rm=T)
median(recnoises$meanPeriod, na.rm=T)
```
clearly this period limiter isn't very effective because the mean period is still 20 years with an sd of 14 years. 

**Simulation III - NEW version - first run view**
```{r}
preylists <-preylist %>% map(~as_tibble(.)) %>% bind_rows(.id="index")%>%as.data.frame()

##visualize the data to make sure it's ok. 
preylist.mean <-preypiv%>%group_by(time_step,age_class)%>%summarize(mean.value=mean(value),.groups='drop')

preylist.mean%>%
 filter(time_step >= 300 & time_step <=400)%>%
 ggplot(aes(time_step,mean.value))+
 geom_line()+
 #geom_point(size=0.5)+
 facet_wrap(~age_class,scales="free")+
  ggtitle("mean after burn in")+
 theme_classic()

preypiv%>%
  filter(index==1)%>%
  filter(time_step >= 300 & time_step <=400)%>%
 ggplot(aes(time_step,value))+
 geom_line()+
 facet_wrap(~age_class,scales="free")+
  ggtitle("first run after burn in")+
 theme_classic()
```

mean is real wiggly but each individual run is too clean. 

**Simulation III - NEW way, plot each age by previous year**
```{r}
#grob plot of each age by itself the previous year.  
agelist <-unique(preypiv$age_class)
plotlist <-list()
for (i in 2:length(agelist)){
  
  df <-preypiv%>%
  filter(time_step >= 299 & time_step <=401)%>%
  filter(age_class==agelist[i] | age_class==agelist[i-1])%>%
    pivot_wider(id_cols=1:2, names_from = age_class, values_from = value)
  
  prev_yrcls_lag=lag(df[,3],1)
  df<-as.data.frame(cbind(df,prev_yrcls_lag))
  names(df)<-c("index","time_step","yrcls","yrPlus1","yrlag")
  df <-dplyr::select(df, -yrcls)%>%filter(time_step >= 300 & time_step <=400)
  
  p <-ggplot(df,aes(yrlag,yrPlus1, color=as.factor(index)))+
  geom_line()+
  ylab(paste(agelist[i],"(t)"))+xlab(paste(agelist[i-1], "(t-1)"))+
    guides(color="none")+
  theme_classic()
 
  plotlist[[i]]<-p
}
plotlist<-plotlist[2:20]
#plotlist

row1 <-plot_grid(plotlist[[1]],plotlist[[2]],plotlist[[3]],plotlist[[4]],plotlist[[5]],ncol=5)
row2 <-plot_grid(plotlist[[6]],plotlist[[7]],plotlist[[8]],plotlist[[9]],plotlist[[10]],ncol=5)
row3 <-plot_grid(plotlist[[11]],plotlist[[12]],plotlist[[13]],plotlist[[14]],plotlist[[15]],ncol=5)
row4 <-plot_grid(plotlist[[16]],plotlist[[17]],plotlist[[18]],plotlist[[19]],ncol=5)

y.grob <-textGrob("Year Class (t)", gp=gpar(fontface="bold",col="black",fontsize=12),rot=90)
x.grob <-textGrob("Prev Year Class (t-1)", gp=gpar(fontface="bold",col="black",fontsize=12))
top.grob <-textGrob("Year class vs. itself", gp=gpar(fontface="bold",col="black",fontsize=12))

mainplot <-plot_grid(row1,row2,row3,row4, nrow=4)
grid.arrange(arrangeGrob(mainplot, left=y.grob, bottom=x.grob,top=top.grob, padding=unit(0,"line")))

####NO LAG###
#grob plot of each age by itself the previous year.  
agelist <-unique(preypiv$age_class)
plotlist <-list()
for (i in 2:length(agelist)){
  
  df <-preypiv%>%
  filter(time_step >= 300 & time_step <=400)%>%
  filter(age_class==agelist[i] | age_class==agelist[i-1])%>%
    pivot_wider(id_cols=1:2, names_from = age_class, values_from = value)
  names(df)<-c("index","time_step","yrcls","yrPlus1")

  p <-ggplot(df,aes(yrcls,yrPlus1, color=as.factor(index)))+
  geom_line()+
  ylab(paste(agelist[i],"(t)"))+xlab(paste(agelist[i-1], "(t)"))+
    guides(color="none")+
  theme_classic()
 
  plotlist[[i]]<-p
}
plotlist<-plotlist[2:20]
#plotlist

row1 <-plot_grid(plotlist[[1]],plotlist[[2]],plotlist[[3]],plotlist[[4]],plotlist[[5]],ncol=5)
row2 <-plot_grid(plotlist[[6]],plotlist[[7]],plotlist[[8]],plotlist[[9]],plotlist[[10]],ncol=5)
row3 <-plot_grid(plotlist[[11]],plotlist[[12]],plotlist[[13]],plotlist[[14]],plotlist[[15]],ncol=5)
row4 <-plot_grid(plotlist[[16]],plotlist[[17]],plotlist[[18]],plotlist[[19]],ncol=5)

y.grob <-textGrob("age i (t)", gp=gpar(fontface="bold",col="black",fontsize=12),rot=90)
x.grob <-textGrob("age i-1 (t)", gp=gpar(fontface="bold",col="black",fontsize=12))
top.grob <-textGrob("age vs previous age", gp=gpar(fontface="bold",col="black",fontsize=12))

mainplot <-plot_grid(row1,row2,row3,row4, nrow=4)
grid.arrange(arrangeGrob(mainplot, left=y.grob, bottom=x.grob,top=top.grob, padding=unit(0,"line")))

```

looks like more nonlinearity which is good. 

