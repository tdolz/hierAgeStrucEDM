---
title: "simulationvisualization"
author: "tara"
date: 8/2/22 - Still being updates. 
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(dplyr)
library(tidyverse)
library(purrr)
library(ggplot2)
library(Metrics)
library(corrplot)
library(kableExtra)
library(metR)
library(cowplot)
library(grid)
library(gridExtra)
library(ggrepel)
```

**import the data**
```{r}
phi_Sim1 <-read.csv("Sim1Phis_100data.csv", header=T)%>%mutate(sim="I")
phi_Sim2 <-read.csv("Sim2Phis_100data.csv", header=T)%>%mutate(sim="II")
phi_Sim3 <-read.csv("Sim3Phis_100data.csv", header=T)%>%mutate(sim="III")
fits1<-read.csv("Sim1fitstats_100data.csv", header=T)%>%mutate(sim="I")
fits2<-read.csv("Sim2fitstats_100data.csv", header=T)%>%mutate(sim="II")
fits3 <-read.csv("Sim3fitstats_100data.csv", header=T)%>%mutate(sim="III")
points30 <-read.csv("thirtypoints.csv", header=T)
```

**thirty points comparison figure**  
requested by Tanya  
debated whether to go with R-squared or RMSE and ultimately settled on R-squared because it can be compared across models (unitless)
https://www.statology.org/rmse-vs-r-squared/ 

```{r}
points30%>%
  filter(rowname=="rmse")%>%
  filter(approach !="fit_all_stats")%>%
  ggplot(aes(approach, value, fill=approach))+
  geom_point(aes(y = value, color =approach), 
               position = position_jitterdodge(), 
             size = 1, alpha = 0.2) +
   geom_boxplot(outlier.shape = NA, alpha = 0.8,
                position=position_dodge2(padding=0.5)) + 
 #scale_fill_manual(values = apocolr)+
  #scale_color_manual(values = apocolr)+
 ylab("Out-of-sample r-squared")+xlab("Approach")+
 facet_wrap(~sim, scales="free",ncol=3)+
 guides(fill=guide_legend(title="Analysis"), color=guide_legend(title="Analysis"))+
 theme(
  axis.text.x = element_text(size=12),
  axis.text.y = element_text(size=12),
  axis.title.x=element_text(size=12,face="bold",margin=margin(t=8,unit="pt")),
  axis.title.y=element_text(size=12,face="bold",margin=margin(r=8,unit="pt")),
  strip.text = element_text(size=12),
  legend.key = element_rect(fill = "transparent"),
  legend.text= element_text(size=12),
  legend.title=element_text(size=12, face="bold"),
  legend.position = "bottom",
  strip.background =element_rect(fill="white"),
  panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_rect(fill = "transparent",colour = "dark grey"),
  plot.background = element_rect(fill = "white",colour = "white", size=0.5),
  panel.border = element_rect(colour="black",fill=NA, size=0.3))

#ggsave("thirtypointsfig.png",path="/Users/tdolan/documents/postdoc/age structure/agestructfigs")
#dev.off()




```


**Tileplot of ARD values for hyperparameters**
```{r}
#create giant dataframe from all simulations
phis <-bind_rows(phi_Sim1, phi_Sim2, phi_Sim3)%>%dplyr::select(-X)%>%rename(models=rowname)
phis <-phis[,c(1,2,3,7,8,9,4,5,6,10,12,13,14,15,11)]
pivphi <-pivot_longer(phis, 2:6, names_to = "name")%>%as.data.frame()

#create pivot version where it's the mean only. 
pivphimean <-pivphi %>% filter(approach != "TAindex")%>%group_by(name,model,sim)%>% summarize(phimean=mean(value),phisd=sd(value),.groups="drop")
pivphimean[is.na(pivphimean)] <-0
#pivphimean <-mutate(pivphimean, tslength=ifelse(rowname=="N_total",100,substr(rowname,1,2)))%>%mutate(tslength=ifelse(tslength=="5y",5,tslength))%>%mutate(maxE=round(sqrt(as.numeric(tslength))))

#discretize the color scale
cols <- c("(0,0.2]"="#f1eef6", "(0.2,0.4]" = "#d0d1e6", "(0.4,0.6]" = "#a6bddb", "(0.6,0.8]" = "#74a9cf", "(0.8,1.0]"  = "#2b8cbe", "(1.0,1.2]"="#045a8d", "(1.2,1.4]" ="#034e7b", "(1.4,1.6]" ="#011f4b")
pivphimean<-mutate(pivphimean, phimean_cut = cut(phimean, breaks=c(0,0.2,0.4,0.6,0.8,1.0,1.2,1.4,1.6)))

# need to fix the legend on this plot. Also maybe the low value color shouldn't be white because it's hard to see. 
ggplot(pivphimean, aes(name,model))+
 geom_tile(aes(fill=phimean_cut), show.legend = TRUE)+
 #scale_fill_gradient(low="white",high="blue")+
 scale_fill_manual(values=cols, na.value = "white")+
 xlab("")+ylab("")+
        #+coord_flip()+
 guides(fill=guide_legend(title="mean value of phi"))+
 facet_wrap(~sim)+
 theme_bw()+
 theme(panel.background = element_rect(fill = "transparent", colour = "black"),
       #axis.text.x = element_text(angle = 90),
       axis.text.x=element_text(size=12),
       axis.text.y=element_text(size=12),
       strip.background =element_rect(fill="white"),
       panel.grid.major = element_blank(), 
       panel.grid.minor = element_blank())
#ggsave("phiplot.png", path="/Users/tdolan/documents/postdoc/age structure/agestructfigs")
ggsave("phiplot.png")
dev.off()
```
**The different approaches**  
hier = normal hierarchical GP fit. The age classes and time series length are what you would expect based on the "models" column.  
single_age = one age at a time, for as many age classes as expected in the model, 100 years of data. 
sumhier = another way of aggregating the hierarchical results. Instead of using the overall prediction aggregated within the r package, take the prediction from the hiearchical model for each age class, first get the observed and predicted. unlog them, add them, then log them again. I am not sure why we did this. 
TAindex = an index of total abundance comprised of the length and number of age classes listed in the models. 

**pivot**
```{r}
newfits <-bind_rows(fits1,fits2,fits3)%>%dplyr::select(-X)

newfits <-mutate(newfits, tslength=ifelse(!is.na(tslength),tslength,substr(model,nchar(model)-1,nchar(model))),tslength)%>%
  mutate(tslength=ifelse(tslength=="05",5,tslength))


#pivot
nfitspiv <-pivot_longer(newfits, 2:9, names_to = "stat")%>%as.data.frame()%>%mutate(model=as.character(model), sim=as.factor(sim))%>%
  mutate(maxE=round(sqrt(as.numeric(tslength))))

#The Hier version
fig2filt <-filter(nfitspiv,stat=="OOS_R2", approach %in% c("TAindex","hier"), model !="preyNT")%>%mutate(tslength=as.factor(tslength))
fig2filt$tslength <-fct_relevel(fig2filt$tslength,c("5","10","20","25"))

#the SumHier version
fig4filt <-filter(nfitspiv,stat=="OOS_R2", 
                  approach %in% c("TAindex","sumhier"), 
                  model %in%c("prey205","prey1010","prey520","prey425"))%>% 
                 # age_class %in% c("4","5","10","20","all"))%>%
  mutate(tslength=as.factor(tslength))
fig4filt$tslength <-fct_relevel(fig4filt$tslength,c("5","10","20","25"))

```

**Boxplot1: Figure total abundance single index to overall estimates from hierarchical models**
under "approach", "sumhier" is the sum total abundance of the hierarchcial models. 
LATER we found that we do not want to compare the summed total abundance estimates to total abundance, but we want to compare overall r-squared to total abundance. So is that "hier"


**Boxplot1: but one at a time**
Boxplot of age structured model next to Ntotal model. 
```{r}
mods1 <-c("prey1010","prey205","prey425","prey520")
tslength<-c(5,10,20,25)

apocolr =c("TAindex"="#b2df8a","sumhier"="#1f78b4")


plotlist <-list()
jlist <-list()
simlist <-c("I","II","III")
for (j in 1:length(simlist)){
for (i in 1:length(tslength)){
    #fits <-filter(fig2filt, tslength==tslength[i])%>%
       fits <-filter(fig4filt, tslength==tslength[i])%>%
    filter(sim==simlist[j])%>%filter(stat %in% c("OOS_R2"))
    #filter(sim=="III")
    means <-fits %>% group_by(approach)%>%summarize(avr2=mean(value))
  ts <-tslength[i]
 p<- fits%>%arrange(tslength)%>%
  ggplot(aes(approach, value,fill=approach))+
  #geom_boxplot(aes(fill=model),alpha=0.7,notch=TRUE, notchwidth = 0.8,width=0.5)+ 
    #geom_flat_violin(position = position_nudge(x = 0.2, y = 0), alpha = 0.8) +
    geom_point(aes(y = value, color = approach), 
              #position = position_jitter(width = 0.15), size = 1, alpha = 0.2) +
   position = position_jitterdodge(dodge.width=2), size = 1, alpha = 0.5) +
    geom_boxplot(width = 0.2, outlier.shape = NA, alpha = 0.8,
                 position=position_dodge2()) +
   geom_line(data = means,aes(x=approach, y=avr2))+
 scale_fill_manual(values = apocolr)+
scale_color_manual(values = apocolr)+
   ylim(min(fits$value),max(fits$value))+
 ylab("")+xlab("")+#ggtitle(ts)+
 #guides(fill=guide_legend(title="model"))+
 guides(color=FALSE, fill=FALSE)+
   theme_bw()+
 theme(
  #axis.text.x = element_text(size=14),
  axis.text.x = element_blank(),
  axis.text.y = element_text(size=14),
  strip.text = element_text(size=14),
  strip.background =element_rect(fill="transparent"),
  legend.position = "none",
  plot.margin=unit(c(1,1,1,1),"pt"), #top right bottom left
  panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_rect(fill = "transparent",colour = "dark grey"),
  plot.background = element_rect(fill = NA,colour = "transparent", size=0.5),
  panel.border = element_rect(colour="transparent",fill=NA, size=0.3))
 plotlist[[i]] <-p
}
 jlist[[j]]<-plotlist
}

plotlist1 <-plot_grid(jlist[[1]][[1]], jlist[[1]][[2]], jlist[[1]][[3]],jlist[[1]][[4]], 
            ncol = 4 #,labels=c("a.","b.","c.","d.")
                      )
plotlist2 <-plot_grid(jlist[[2]][[1]], jlist[[2]][[2]], jlist[[2]][[3]],jlist[[2]][[4]], 
                      ncol = 4 #,labels=c("e.","f.","g.","h.")
                      )
plotlist3 <-plot_grid(jlist[[3]][[1]], jlist[[3]][[2]], jlist[[3]][[3]],jlist[[3]][[4]], 
                      ncol = 4 #,labels=c("i.","j.","k.","l.")
                      )

y.grob <- textGrob("Out-of-sample r-squared", 
                   gp=gpar(fontface="bold", col="black", fontsize=12), rot=90)

x.grob <- textGrob("", 
                   gp=gpar(fontface="bold", col="black", fontsize=12))


mainplot <-plot_grid(plotlist1,plotlist2,plotlist3, nrow = 3)
grid.arrange(arrangeGrob(mainplot, left = y.grob, top = x.grob,padding = unit(20, "line")))

#ggsave("cplotattempt.png", path="/Users/tdolan/documents/postdoc/age structure/agestructfigs")
#ggsave("cplotattempt2.png", path="/Users/tdolan/documents/postdoc/age structure/agestructfigs")
#ggsave("cplotattempt3.png", height=10, width=10, dpi=300, path="/Users/tdolan/documents/postdoc/age structure/agestructfigs")
#ggsave("cplotattempt4.png", height=10, width=10, dpi=300, path="/Users/tdolan/documents/postdoc/age structure/agestructfigs")
ggsave("cplotattempt4sumhier.png", height=12, width=10, path="/Users/tdolan/documents/postdoc/age structure/agestructfigs")
#dev.off()
```

**Boxplot1: Tanya's version***
My thought is to have 3 panels stacked vertically, one for each simulation, each with its own vertical axis. Horizontal axis (shared) is time series length (years). At each horizontal axis tick there are 2 boxplots (or points and error bars) of different colors side by side (you may have to map color rather than fill if some end up being small). One color is 'with age structure', the other is 'total abundance' indicated in legend. Caption will explain that the models with age structure use the number of age classes such that number of years*number of age classes = 100 data points (see main text), or something like that. Explain that the variation shown is among 100 replicate simulations.
```{r}
apocolr =c("TAindex"="#b2df8a","hier"="#1f78b4")

fig2filt%>%
  ggplot(aes(tslength, value, fill=approach))+
  geom_point(aes(y = value, color =approach), 
               position = position_jitterdodge(), 
             size = 1, alpha = 0.2) +
   geom_boxplot(outlier.shape = NA, alpha = 0.8,
                position=position_dodge2(padding=0.5)) + 
   #geom_violin()+
 scale_fill_manual(values = apocolr)+
  scale_color_manual(values = apocolr)+
 ylab("Out-of-sample r-squared")+xlab("Time series length (years)")+
 facet_wrap(~sim, scales="free",ncol=3)+
 guides(fill=guide_legend(title="Analysis"), color=guide_legend(title="Analysis"))+
 theme(
  axis.text.x = element_text(size=12),
  axis.text.y = element_text(size=12),
  axis.title.x=element_text(size=12,face="bold",margin=margin(t=8,unit="pt")),
  axis.title.y=element_text(size=12,face="bold",margin=margin(r=8,unit="pt")),
  strip.text = element_text(size=12),
  legend.key = element_rect(fill = "transparent"),
  legend.text= element_text(size=12),
  legend.title=element_text(size=12, face="bold"),
  legend.position = "bottom",
  strip.background =element_rect(fill="white"),
  panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_rect(fill = "transparent",colour = "dark grey"),
  plot.background = element_rect(fill = "white",colour = "white", size=0.5),
  panel.border = element_rect(colour="black",fill=NA, size=0.3))

ggsave("ntotallengthsTanya2.png",path="/Users/tdolan/documents/postdoc/age structure/agestructfigs")
#dev.off()


```



**Boxplot1: Same as above but use sum hier instead of hier***
```{r}
apocolr =c("TAindex"="#b2df8a","sumhier"="#1f78b4")

fig4filt <-filter(nfitspiv,stat=="OOS_R2", 
                  approach %in% c("TAindex","sumhier"), 
                  model %in%c("prey205","prey1010","prey520","prey425"))%>% 
                 # age_class %in% c("4","5","10","20","all"))%>%
  mutate(tslength=as.factor(tslength))
fig4filt$tslength <-fct_relevel(fig4filt$tslength,c("5","10","20","25"))


fig4filt%>%
  ggplot(aes(tslength, value, fill=approach))+
  geom_point(aes(y = value, color =approach), 
               position = position_jitterdodge(), 
             size = 1, alpha = 0.2) +
   geom_boxplot(outlier.shape = NA, alpha = 0.8,
                position=position_dodge2(padding=0.5)) + 
   #geom_violin()+
 scale_fill_manual(values = apocolr)+
  scale_color_manual(values = apocolr)+
 ylab("Out-of-sample r-squared")+xlab("Time series length (years)")+
 facet_wrap(~sim, scales="free",ncol=3)+
 guides(fill=guide_legend(title="Analysis"), color=guide_legend(title="Analysis"))+
 theme(
  axis.text.x = element_text(size=12),
  axis.text.y = element_text(size=12),
  axis.title.x=element_text(size=12,face="bold",margin=margin(t=8,unit="pt")),
  axis.title.y=element_text(size=12,face="bold",margin=margin(r=8,unit="pt")),
  strip.text = element_text(size=12),
  legend.key = element_rect(fill = "transparent"),
  legend.text= element_text(size=12),
  legend.title=element_text(size=12, face="bold"),
  legend.position = "bottom",
  strip.background =element_rect(fill="white"),
  panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_rect(fill = "transparent",colour = "dark grey"),
  plot.background = element_rect(fill = "white",colour = "white", size=0.5),
  panel.border = element_rect(colour="black",fill=NA, size=0.3))

#ggsave("ntotallengthsTanyaOVERALhier.png",path="/Users/tdolan/documents/postdoc/age structure/agestructfigs")
#dev.off()


```

**Boxplot 2: 100 data points test**
hierarchical models of 100 data points. 
```{r}
fig3filt <-filter(nfitspiv,stat=="OOS_rmse", approach %in% c("TAindex","hier"), 
                  model %in% c("preyNT","prey205","prey1010","prey520","prey425"),
                  age_class =="all")%>% 
  mutate(tslength=as.factor(tslength))
fig3filt$tslength <-fct_relevel(fig3filt$tslength,c("5","10","20","25","100"))
fig3filt$model <-fct_relevel(fig3filt$model,c("prey205","prey1010","prey520","prey425","preyNT"))

fig3filt%>%
  ggplot(aes(tslength, value))+
  geom_point(aes(y = value), color="#1f78b4",
               position = position_jitter(width=0.2), size = 1, alpha = 0.4) +
    geom_boxplot(width = 0.3, outlier.shape = NA, alpha = 0.8,fill="#1f78b4") +
    #geom_flat_violin(position = position_nudge(x = 0.2, y = 0), alpha = 0.8) +
 ylab("R-squared")+
 facet_wrap(~sim, scales="free_y")+
 guides(fill=guide_legend(title="analysis"))+
 theme(
  axis.text.x = element_text(size=12),
  axis.text.y = element_text(size=12),
  axis.title.x=element_text(size=12,face="bold",margin=margin(t=8,unit="pt")),
  axis.title.y=element_text(size=12,face="bold",margin=margin(r=8,unit="pt")),
  strip.text = element_text(size=12),
  legend.key = element_rect(fill = "transparent"),
  legend.text= element_text(size=12),
  legend.title=element_text(size=12, face="bold"),
  legend.position = "bottom",
  strip.background =element_rect(fill="white"),
  panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_rect(fill = "transparent",colour = "dark grey"),
  plot.background = element_rect(fill = "white",colour = "white", size=0.5),
  panel.border = element_rect(colour="black",fill=NA, size=0.3))


ggsave("ntotallengthsno6.png", path="/Users/tdolan/documents/postdoc/age structure/agestructfigs")
dev.off()
```





**summary dynamic correlation**
```{r}
sumfits <-nfitspiv %>% 
  filter(stat=="rho" & approach=="hier")%>%
  filter(tslength != "100")%>%
  group_by(sim, model)%>% summarize('mean dynamic rho'=mean(value), "std. dev. dynamic rho"=sd(value), .groups="drop")%>%mutate(across(c(3,4), round,3))



sumfits%>%arrange(model,sim)%>% kbl()%>%kable_classic(full_width = F, html_font = "Cambria")

```


**measure dynamic correlation in each simulation**
```{r}

nfitspiv %>%
 filter(stat == "rho")%>%
  filter(model != "preyNT")%>%
 ggplot(aes(models,value, fill=models))+
 geom_boxplot(notch=T, notchwidth = 0.8)+
 xlab("model")+ylab("mean dynamic rho")+
 scale_fill_manual(values=simcols3)+
 facet_wrap(~sim)+
 theme(
  axis.text.x = element_text(size=9, angle=90),
  axis.text.y = element_text(size=7),
  strip.background =element_rect(fill="transparent"),
  strip.text = element_text(size=9),
  legend.position = "none",
  panel.spacing = unit(1.5, "mm"),
  panel.grid.major = element_blank(), 
  panel.grid.minor = element_blank(),
  panel.background = element_rect(fill = "transparent",colour = "dark grey"),
  plot.background = element_rect(fill = NA,colour = "black", size=0.5),
  panel.border = element_rect(colour="black",fill=NA, size=0.3)
 )

#ggsave("meandynamicrho.png", path="/Users/tdolan/documents/postdoc/age structure/agestructfigs")
#dev.off()
```

**Comparison of hierarchical, mixed and single age models: IMPORT DATA**
```{r}
#read in empirical data
#emp <-read.csv("mixedage_fitstats_emp.csv", header=T)
emp <-read.csv("mixedage_fitstats_empLOG.csv", header=T)## LOG SCALE VERSION

#format the data & fix the age of the salmon data
emp <-emp %>% separate(model,c("species","modeltype"),sep="_",remove=F)%>%
  mutate(age=as.numeric(age))%>%
  mutate(age=ifelse(species=="KRFC",age+1,age))%>%
  mutate(age=ifelse(is.na(age),"all",age))


#make sure the names are consistent
emp$modeltype=fct_recode(emp$modeltype, "Hier"="Hier", "IndvAge"="indvAge","MixedAge"="mixedAge","Hier"="ageStruc","NTotal"="Ntotal")
emp2 <-dplyr::select(emp, age, OOS_R2,OOS_rmse, modeltype, species)%>%dplyr::rename(model=modeltype)

#read in simulated data - all are logged
mx1spp <-read.csv("mixedtest301spp.csv", header=T)%>%mutate(species="I")
mx2sppMED <-read.csv("mixedtest302sppMED.csv", header=T)%>%mutate(species="II")
mx2sppXXL <-read.csv("mixedtest302sppXXL.csv", header=T)%>%mutate(species="III")

#format the data
mixsim <-bind_rows(mx1spp,mx2sppMED,mx2sppXXL)
mixsimsum <-mixsim %>% group_by(species,model,age)%>%
  summarize(OOSR2=mean(OOS_R2),sdOOSR2=sd(OOS_R2),OOSrmse=mean(OOS_R2),sdOOSrmse=sd(OOS_rmse),.groups="drop")%>%dplyr::rename(OOS_R2=OOSR2, OOS_rmse=OOSrmse)
mixsimsum$model <-fct_recode(mixsimsum$model,"Hier"="Hier","IndvAge"="IndvAge","MixedAge"="Mixed","Hier"="modHier","NTotal"="modNT")

#bind together
mixall<-bind_rows(mixsimsum,emp2)%>%as.data.frame()
mixall$age <-fct_relevel(mixall$age,"1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19" ,"20","all")

#turn the Ntotal model into a subset of the IndAge model
mixall$model <-fct_recode(mixall$model, "IndvAge"="NTotal")
mixall$model <-fct_recode(mixall$model,"Hierarchal"="Hier","Single Age"="IndvAge","Mixed Age"="MixedAge")

#the og permutation data for little violins
mixsim$model <-fct_recode(mixsim$model,"Hier"="Hier","IndvAge"="IndvAge","MixedAge"="Mixed","Hier"="modHier","NTotal"="modNT")
mix2<-bind_rows(mixsim,emp2)%>%as.data.frame()
mix2$model <-fct_recode(mix2$model, "IndvAge"="NTotal")
mix2$model <-fct_recode(mix2$model,"Hierarchal"="Hier","Single Age"="IndvAge","Mixed Age"="MixedAge")
mix2$age <-fct_relevel(mix2$age,"1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19" ,"20","all")

```

**plot the mixed comparison data**
```{r}
mixall%>%
  #filter(species %in% c("I","II","III"))%>%
  ggplot(aes(age, OOS_R2, fill=species))+
  geom_point(aes(fill=species), alpha=0.7)+ 
  geom_errorbar(aes(x=age,y=OOS_R2,ymin=OOS_R2-sdOOSR2, ymax=OOS_R2+sdOOSR2),width=0, size=0.5, position=position_dodge(0.05)) + 
  #ylim(0.99,1.00)+
 ylab("out of sample r-squared")+
 facet_grid(species~model, scales="free")+
 #guides(fill=guide_legend(title="data source"))+
  theme_bw()+
  theme(strip.background =element_rect(fill="white"))
```

**another way to plot**
```{r}
#modlcols <-c("Single Age"="red","Hierarchal"="grey", "Mixed Age"="blue")
modlcols <-c("Single Age"="grey","Hierarchal"="grey", "Mixed Age"="grey")

mixall%>%
  filter(age != "all")%>%
  #filter(species %in% c("I","II","III"))%>%
  ggplot(aes(model, OOS_R2))+
  geom_point(aes(y = OOS_R2), 
               position = position_jitter(width=0.15), 
             size = 1,color="grey") +
 geom_boxplot(outlier.shape=NA, width=0.3, fill="grey", alpha=0.6)+
  geom_point(data=filter(mixall, age == "all"),aes(y = OOS_R2), 
               position = position_dodge2(), 
             size = 2, shape=19) +
#geom_flat_violin(aes(fill=model),position = position_nudge(x = 0.2, y = 0), alpha = 0.8) +
 ylab("Out-of-sample r-squared")+xlab("")+
 #facet_grid(~species, scales="free_y")+
  facet_wrap(~species, scales="free_y",nrow=2)+
  #facet_wrap(~species, scales="free")+
  theme(
  axis.text.x = element_text(size=12),
  axis.text.y = element_text(size=12),
  axis.title.x=element_text(size=14,face="bold",margin=margin(t=8,unit="pt")),
  axis.title.y=element_text(size=14,face="bold",margin=margin(r=8,unit="pt")),
  strip.background =element_rect(fill="transparent"),
  strip.text = element_text(size=12),
  legend.position = "none",
  panel.spacing = unit(1.5, "mm"),
  panel.grid.major = element_blank(), 
  panel.grid.minor = element_blank(),
  panel.background = element_rect(fill = "transparent",colour = "dark grey"),
  plot.background = element_rect(fill = NA,colour = "transparent"),
  panel.border = element_rect(colour="black",fill=NA, size=0.3)
 )
#ggsave("TinyviolinsTanya.png", path="/Users/tdolan/documents/postdoc/age structure/agestructfigs")
#dev.off()
```


**top panel**
```{r}
modlcols <-c("Single Age"="red","Hierarchal"="grey", "Mixed Age"="blue")
#modlcols <-c("Single Age"="grey","Hierarchal"="grey", "Mixed Age"="grey")

mixall%>%
  filter(age != "all")%>%
  filter(species %in% c("I","II","III"))%>%
  ggplot(aes(species, OOS_R2, fill=model))+
  geom_point(aes(y = OOS_R2, color =model), 
               position = position_jitterdodge(dodge.width = 0.75, jitter.width = 0.2), 
             size = 1, alpha = 0.8) +
  #geom_errorbar(aes(x=species,y=OOS_R2,ymin=OOS_R2-sdOOSR2, ymax=OOS_R2+sdOOSR2, color=model, fill=model),width=0, size=0.5, position=position_jitterdodge()) + 
 #geom_text_repel(aes(label=age), hjust=0, size=3,nudge_x = -0.5, max.overlaps = 20)+
 geom_boxplot(aes(x=species, y = OOS_R2, fill =model),outlier.shape=NA, width=0.7, alpha=0.4, 
              position = position_dodge2(padding=0.5))+
   geom_point(data=filter(mixall, species %in% c("I","II","III") & age == "all"),aes(y = OOS_R2, color=model), 
               position = position_jitterdodge(dodge.width = 0.4, jitter.width = 0), 
              #position= position_nudge(x=-0.1, y=0),
             size = 2, shape=8) +
  scale_color_manual(values = modlcols)+
 scale_fill_manual(values = modlcols)+
 ylab("Out-of-sample r-squared")+xlab("")+
 guides(fill=guide_legend(title="Modelling approach"),color=guide_legend(title="modelling approach"))+
  theme(
  axis.text.x = element_text(size=12),
  axis.text.y = element_text(size=12),
  axis.title.x=element_text(size=14,face="bold",margin=margin(t=8,unit="pt")),
  axis.title.y=element_text(size=14,face="bold",margin=margin(r=8,unit="pt")),
  strip.background =element_rect(fill="transparent"),
  strip.text = element_text(size=12),
  legend.position = "none",
  panel.spacing = unit(1.5, "mm"),
  panel.grid.major = element_blank(), 
  panel.grid.minor = element_blank(),
  panel.background = element_rect(fill = "transparent",colour = "dark grey"),
  plot.background = element_rect(fill = NA,colour = "transparent", size=0.5),
  panel.border = element_rect(colour="black",fill=NA, size=0.3)
 )

#ggsave("TopPanel.png", path="/Users/tdolan/documents/postdoc/age structure/agestructfigs")
#dev.off()
```

**bottom panel**
```{r}
modlcols <-c("Single Age"="red","Hierarchal"="grey", "Mixed Age"="blue")
#modlcols <-c("Single Age"="grey","Hierarchal"="grey", "Mixed Age"="grey")

mixall%>%
  filter(age != "all")%>%
  filter(species %in% c("SB","KRFC"))%>%
  ggplot(aes(species, OOS_R2, fill=model))+
  geom_point(aes(y = OOS_R2, color =model), 
               position = position_jitterdodge(dodge.width = 0.75, jitter.width = 0.2), 
             size = 1, alpha = 0.8) +
 geom_boxplot(aes(x=species, y = OOS_R2, fill =model),outlier.shape=NA, width=0.7, alpha=0.4, 
              position = position_dodge2(padding=0.5))+
   geom_point(data=filter(mixall, species %in% c("SB","KRFC") & age == "all"),aes(y = OOS_R2, color=model), 
               position = position_jitterdodge(dodge.width = 0.5, jitter.width = 0), 
             size = 2, shape=8) +
  scale_color_manual(values = modlcols)+
 scale_fill_manual(values = modlcols)+
 ylab("Out-of-sample r-squared")+xlab("")+
 guides(fill=guide_legend(title="modelling approach"),color=guide_legend(title="modelling approach"))+
  theme(
  axis.text.x = element_text(size=12),
  axis.text.y = element_text(size=12),
  axis.title.x=element_text(size=14,face="bold",margin=margin(t=8,unit="pt")),
  axis.title.y=element_text(size=14,face="bold",margin=margin(r=8,unit="pt")),
  strip.background =element_rect(fill="transparent"),
  strip.text = element_text(size=12),
  legend.position = "bottom",
  legend.key = element_rect(fill = "transparent"),
  legend.text= element_text(size=12),
  legend.title=element_text(size=12),
  panel.spacing = unit(1.5, "mm"),
  panel.grid.major = element_blank(), 
  panel.grid.minor = element_blank(),
  panel.background = element_rect(fill = "transparent",colour = "dark grey"),
  plot.background = element_rect(fill = NA,colour = "transparent", size=0.5),
  panel.border = element_rect(colour="black",fill=NA, size=0.3)
 )

#ggsave("bottomPanel.png", path="/Users/tdolan/documents/postdoc/age structure/agestructfigs")
#dev.off()
```



**some summary stats**
```{r}
mixall%>%
  #filter(species %in% c("KRFC","SB"))%>%
  filter(species %in% c("I","II","III"))%>%
  filter(age !="all")%>%
  group_by(model)%>%summarize(meanr2=mean(OOS_R2),sdr2=sd(OOS_R2))

mixall%>%
  filter(species %in% c("KRFC","SB"))%>%
  filter(age !="all")%>%
  group_by(species)%>%summarize(meanr2=mean(OOS_R2),sdr2=sd(OOS_R2))

mixall%>%
  #filter(species %in% c("KRFC","SB"))%>%
  filter(species %in% c("I","II","III"))%>%
  #filter(age !="all")%>%
  filter(age =="all")%>%
  group_by(model,species)%>%summarize(meanr2=mean(OOS_R2),sdr2=sd(OOS_R2),.groups = "drop")

mixall%>%
  #filter(species %in% c("KRFC","SB"))%>%
  filter(age =="all")%>%
  group_by(model,species)%>%summarize(meanr2=mean(OOS_R2),sdr2=sd(OOS_R2),.groups = "drop")

mixall%>%
  filter(species %in% c("KRFC","SB"))%>%
  filter(age =="all")%>%
  group_by(model)%>%summarize(meanr2=mean(OOS_R2),sdr2=sd(OOS_R2),.groups = "drop")

```
**tiny violins**
```{r}
mix2$age <-fct_relevel(mix2$age,"1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19" ,"20","all")

mix2%>%
  ggplot()+
  #geom_point(data=filter(mix2,species %in% c("SB","KRFC")),aes(age, OOS_R2), alpha=0.7)+ 
  #geom_flat_violin(data=filter(mix2,species %in% c("I","II","III")),aes(age, OOS_R2, fill=species))+
  #geom_boxplot(data=filter(mix2,species %in% c("I","II","III")),aes(age, OOS_R2), outlier.size=0.2)+
  geom_boxplot(aes(age, OOS_R2),outlier.size=0.2)+
  #ylim(0.99,1.00)+
 ylab("Out of sample r-squared")+ xlab("Age class")+
 facet_grid(species~model, scales="free")+
 #guides(fill=guide_legend(title="data source"))+
  theme_bw()+
  theme(strip.background =element_rect(fill="white"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(size=10),
  axis.text.y = element_text(size=10),
  strip.text = element_text(size=12),
  axis.title.x=element_text(size=12,face="bold",margin=margin(t=8,unit="pt")),
  axis.title.y=element_text(size=12,face="bold",margin=margin(r=8,unit="pt")),
        )

ggsave("tinyviolins.pdf",width = 12, height = 6,path="/Users/tdolan/documents/postdoc/age structure/agestructfigs")
dev.off()
```


**Import parallel crossfits data**
```{r}
#the following CSVs were created on the 50 core server using the script parallelCrossfit.R. There is also a version on the local machine.
#
#The NEWER versions are on the bottom. 

#TWO SPECIES XXL 
#pxfits <-read.csv("crossfits2sppXXLrestrictMaxE.csv",header=TRUE) #option 1 
#pxfits <-read.csv("crossfits2sppXXLOpt2MaxE.csv",header=TRUE) # option 2
#pxfits <-read.csv("crossfits2sppXXLSteveoos2.csv",header=TRUE) # option 2
#pxfits <-read.csv("crossfits2sppXXLTau4.csv",header=TRUE) # altering tau
pxfits<-read.csv("crossfits2sppXXLSHORTOSC_LN.csv",header=TRUE) #shorter oscillations, logged
#TWO SPECIES MEDIUM
#pxfits <-read.csv("crossfits2sppMEDrestrictMaxE.csv",header=TRUE) #option 1 
#pxfits <-read.csv("crossfits2sppMEDTau2.csv",header=TRUE) # playing with tau
#pxfits<-read.csv("crossfits2sppMED_LN.csv",header=TRUE) #tanyas changes and logged. 
#ONE SPECIES RICKER
##pxfits <-read.csv("crossfitsONESPPrestrictMaxE.csv",header=TRUE) #option 1 
#pxfits <-read.csv("crossfitsONESPPTau2.csv",header=TRUE) # playing with tau 
#pxfits<-read.csv("crossfitsONESPP_LN.csv",header=TRUE) #tanyas changes and logged. 
```

```{r}
#inspect preylist
#preylist <-read.csv("preylists2sppXXLSHORTOSC.csv") #two species xxl
#preylist <-read.csv("preylists2sppXXL.csv") #two species xxl
#preylist <-read.csv("preylists2sppMED.csv") #two species med
#preylist <-read.csv("preylistsOneSpp.csv") #one species
#
preylist <-filter(preylist, age_class !="V21")

preylist$age <-fct_recode(preylist$age_class, "1"="V1","2"="V2","3"="V3","4"="V4","5"="V5","6"="V6","7"="V7","8"="V8","9"="V9","10"="V10","11"="V11","12"="V12","13"="V13","14"="V14","15"="V15","16"="V16","17"="V17","18"="V18","19"="V19","20"="V20")
preylist <-mutate(preylist, age=as.numeric(as.character(age)))

preylist%>%
  #filter(index <= 25)%>%  #look at 25 plots at a time or it crashes.. 
  #filter(index > 25 & index <= 50)%>%
  #filter(index > 50 & index <= 75)%>%
  #filter(index > 75)%>%
  filter(time_step > 299 & time_step < 310)%>%
  filter(index == 1)%>%
  #mutate(value=log(value))%>% 
  ggplot(aes(time_step,value))+
  scale_x_continuous(breaks=seq(300,310,2))+
  geom_line()+
  geom_vline(xintercept = 305, color="blue",lty="dotted")+
  ylab("abundance")+xlab("time step")+ggtitle("simulation I (LN)")+
  facet_wrap(~age,scales="free")+
  theme_classic()
#ggsave("preyvisSim_ILN.png", path="/Users/tdolan/documents/postdoc/age structure/agestructfigs")
#dev.off()

summaryprey <- preylist %>% group_by(index)%>%summarize(rec1=min(recnoise1), rec2=min(recnoise2), popcrash=min(value), poppeak=max(value), varpop=var(value), meanpop=mean(value))
```

**Visualize parallel crossfits data: step one, organize the data**
```{r}

pxfits$age <-fct_recode(pxfits$age_class, "1"="V1","2"="V2","3"="V3","4"="V4","5"="V5","6"="V6","7"="V7","8"="V8","9"="V9","10"="V10","11"="V11","12"="V12","13"="V13","14"="V14","15"="V15","16"="V16","17"="V17","18"="V18","19"="V19","20"="V20")

pxfits <-mutate(pxfits, age=as.numeric(as.character(age)))#%>%mutate(numpoints=time_step*age, NRMSE=rmse/obs_SD)

#turn this on and off
#pxfits <-na.omit(pxfits)

###mean and standard deviation of the time series. 
pxsum <-pxfits %>%group_by(age, time_step)%>%summarize(medRSQ=median(Rsq), sdRSQ = sd(Rsq), meanRSQ=mean(Rsq), E=max(E), sdRMSE=sd(rmse), meanRMSE=mean(rmse),sdDYRHO=sd(dy_rho), meanDYRHO=mean(dy_rho),maxRSQ =max(Rsq),
                                                       #meanNRMSE=mean(NRMSE), sdNRMSE=sd(NRMSE),
                                                       .groups='drop')

#calc r-squared range
min(pxsum$meanRSQ)
max(pxsum$meanRSQ)

#filter and then calculate
pxcut <-filter(pxsum, time_step <=20)
min(pxcut$meanRSQ)
max(pxcut$meanRSQ)

#fancy finagling for the 2 spp medium
#pxsum <-mutate(pxsum, corrMeanRsq = ifelse(meanRSQ < -1.2, -1.2, meanRSQ))

#cut off dataframe - REMEMBER TO TURN THIS OFF
#pxsum = filter(pxsum, time_step > 5 & age >= 4)
```

**Contour plot in Plotly**
```{r}
#what is the metric you are trying to make a plot out of?
met <-"meanRSQ"
metname <-"mean r-squared"

#max z back into a matrix
rhomat <-pivot_wider(pxsum, id_cols="time_step",names_from = "age",values_from = met)
rhomat <-rhomat %>% remove_rownames %>% mutate(time_step =time_step - 10) %>% column_to_rownames(var="time_step") #when using the 10 year sequential
#rhomat <-rhomat %>% remove_rownames %>% column_to_rownames(var="time_step")
rhomat <-as.matrix(rhomat)

#As surface plot
#fig <-plot_ly(type="surface",
             # x=~rownames(rhomat), y=~colnames(rhomat), z=~t(rhomat))
#fig %>% layout(scene = list(xaxis = list(title = 'years included', nticks=8, range=c(5,40)),
                                     #yaxis = list(title = 'number age classes included', nticks=10, range=c(1,20)),
                                     #zaxis = list(title = 'r-squared',nticks=10, range=c(0,1)))) 
                                     #zaxis = list(title = metname)))
                                     #
#calc r-squared range
 

#zooming in
#rhomat <-rhomat[1:11,] #5-15     
rhomat2 <-rhomat[6:11,1:10] #10-15 years, 1-10 ages  
#rhomat <-rhomat[11:16,1:10] #11-16 years, 1-10 ages  #for the 2 spp med

z_data = t(rhomat)

contours <- list(
    showlabels = TRUE,
    start = floor(min(unlist(z_data))), #the min for sim III full data is -1.078, so lets go to -1.1, the max is 0.999758, 
    end = ceiling(max(unlist(z_data))),
    labelfont = list(size = 20, color = "black"))

#whole plot
fig1 <-plot_ly(type="contour",
               contours = list(showlabels = TRUE),
               #contours = contours,
               #colorscale='Jet',
               #coloraxis="coloraxis",
               #colorscale = list(c(-1.2,-1.0,-0.8,-0.6,-0.5,-0.4,-0.2,0,0.1,0.4,0.6,0.8,0.9,1.0)),
               #colorscale = list(seq(0.78,1.0,0.02),c("#dc2f02","#d00000","#9d0208","#6a040f","#370617","#03071e")),
               colorbar=list(tickfont=list(size=14)),
               reversescale =F,
               autocontour = F, #contours = list(start = -1.2, end = 1.0,size = 0.2),
               x=~rownames(rhomat), y=~colnames(rhomat), z=~t(rhomat))%>%
      colorbar(title=metname, size=14)%>%
      layout(xaxis = list(title = 'years included',tickfont = list(size = 14),titlefont = list(size = 14),
                          #nticks=25,range=c(5,30)),
                          nticks=10),
                                     yaxis = list(title = 'number age classes included',
                                                  tickfont = list(size = 14),titlefont = list(size = 14)),
                                     zaxis = list(title = 'r-squared',nticks=10, range=c(0,1),tickfont = list(size = 14)))
                                    # zaxis = list(title = metname))   
  

#zoom in 
fig2 <-plot_ly(type="contour",
               contours = list(showlabels = TRUE),
               #contours = contours,
               colorscale='Jet',
               #colorscale = list(seq(0.78,1.0,0.02),c("#dc2f02","#d00000","#9d0208","#6a040f","#370617","#03071e")),
               #coloraxis="coloraxis",
               colorbar=list(tickfont=list(size=14)),
               reversescale =F,
               autocontour = F, #contours = list(start = -1.2, end = 1.0,size = 0.2),
               x=~rownames(rhomat2), y=~colnames(rhomat2), z=~t(rhomat2))%>%
      colorbar(title=metname, size=14)%>%
      layout(xaxis = list(title = 'years included',
                          tickfont = list(size = 14), titlefont = list(size = 14),
                          nticks=10),
                                     yaxis = list(title = 'number age classes included',
                                                  tickfont = list(size = 14),titlefont = list(size = 14)),
                                     zaxis = list(title = 'r-squared',nticks=10, range=c(0,1)))
                                    # zaxis = list(title = metname))   
 
#fig <- subplot(fig1, fig2)
#fig <- fig %>% layout(coloraxis=list(colorscale='Jet'))

fig1
fig2
```

**mean dynamic correlation in plotly**
```{r}
#what is the metric you are trying to make a plot out of?
met <-"meanDYRHO"
metname <-"mean dynamic correlation"

#max z back into a matrix
rhomat <-pivot_wider(pxsum, id_cols="time_step",names_from = "age",values_from = met)
rhomat <-rhomat %>% remove_rownames %>% mutate(time_step =time_step - 10) %>% column_to_rownames(var="time_step") #when using the 10 year sequential
#rhomat <-rhomat %>% remove_rownames %>% column_to_rownames(var="time_step")
rhomat <-as.matrix(rhomat)

#As surface plot
#fig <-plot_ly(type="surface",
             # x=~rownames(rhomat), y=~colnames(rhomat), z=~t(rhomat))
#fig %>% layout(scene = list(xaxis = list(title = 'years included', nticks=8, range=c(5,40)),
                                     #yaxis = list(title = 'number age classes included', nticks=10, range=c(1,20)),
                                     #zaxis = list(title = 'r-squared',nticks=10, range=c(0,1)))) 
                                     #zaxis = list(title = metname)))
                                     #
#calc r-squared range
 

#zooming in
#rhomat <-rhomat[1:11,] #5-15     
#rhomat <-rhomat[6:11,1:10] #10-15 years, 1-10 ages  

#as contour plot
#https://community.plotly.com/t/what-colorscales-are-available-in-plotly-and-which-are-the-default/2079
#https://stackoverflow.com/questions/55164195/how-to-manually-set-the-color-scale-in-contour-plots-r-plotly
fig2 <-plot_ly(type="contour",contours = list(showlabels = TRUE),
               #colorscale='Picnic',
               colorscale = list(c(0, 0.5, 1), c('blue', 'yellow', 'red')),
               reversescale =F,
               autocontour = F, contours = list(start = 0, end = 1.0,size = 0.5),
               x=~rownames(rhomat), y=~colnames(rhomat), z=~t(rhomat))%>%
      colorbar(title=metname)%>%
      layout(xaxis = list(title = 'years included',
                          #nticks=25,range=c(5,30)),
                          nticks=10),
                                     yaxis = list(title = 'number age classes included'),
                                     #zaxis = list(title = 'r-squared',nticks=10, range=c(0,1)))) 
                                     zaxis = list(title = metname))   
fig2   

```


**Contour in ggplot**
```{r}

#ZOOM IN 
pxsum2 <-filter(pxsum, time_step <= 25 & time_step >=20 & age <=10)
#pxsum2 <-pxsum

#yet another way to do contour plots (in ggplot)
rsqcont <-dplyr::select(pxsum2, age, time_step, meanRSQ)%>%mutate(time_step=time_step-10)%>%as.data.frame
rsqcont %>%
  ggplot(aes(x=time_step,y=age,z=meanRSQ))+
  #geom_contour_filled()+
  geom_tile(color="white", fill="white")+
  #scale_color_manual(labels = c("T999", "T888"), values = c("blue", "red")) +
  geom_contour()+
  scale_x_continuous(breaks=seq(min(rsqcont$time_step), max(rsqcont$time_step),1))+
  scale_y_continuous(breaks=seq(min(rsqcont$age),max(rsqcont$age),1))+
  #xlim(5,30)+
  geom_text_contour(aes(z = round(meanRSQ,2)), check_overlap = TRUE)+
  xlab("number of years included")+ylab("age classes included")+
  #scale_x_discrete(limits=c(as.character(seq(5,30,1))))+
  theme_classic()
```

**as a tile plot**
```{r}
cols <- c("(-1.2,-1.0]"="white","(-1.0,-0.8]"="#f1eef6", "(-0.6,-0.4]" = "#d0d1e6", "(-0.4,-0.2]" = "#a6bddb", "(-0.2,0]" = "#74a9cf", "(0,0.2]"  = "#2b8cbe", "(0.2,0.4]"="#045a8d", "(0.4,0.6]" ="#034e7b", "(0.6,0.8]" ="#011f4b","(0.8,1.0]" ="black")

#p <- separate(p, contrast, c("bayyear1", "bayyear2"),sep="-")
#p<-mutate(p, p_if_sig=ifelse(sigp=="sig",p.value,NA), starsig=ifelse(sigp=="sig","*",NA)) 
pxsum3<-mutate(pxsum, meanRSQcut = cut(meanRSQ, breaks=seq(-1.2,1,0.2)))
ggplot(pxsum3, aes(age,time_step))+
  geom_tile(aes(fill=meanRSQ), show.legend = TRUE)+
  scale_fill_viridis_c()+
  #scale_fill_manual(values=cols)+
  #geom_text(color="white", size=3)+
  xlab("")+ylab("")+
  theme(axis.text.x = element_text(angle = 90),panel.background = element_rect(fill = "white", colour = "black"))

```


**As a table**
```{r}
round(rhomat,3) %>% kbl()%>%kable_classic(full_width = T, html_font = "Cambria")

```

**zoom in on the contour plot for 10 years: PLOTLY**
```{r}
#ZOOM IN ON THE CONTOUR PLOT
pxsum_clip <-filter(pxsum, time_step <= 10)

#what is the metric you are trying to make a plot out of?
met <-"meanRSQ"
metname <-"mean R-squared"
  
#max z back into a matrix
rhomat <-pivot_wider(pxsum_clip, id_cols="time_step",names_from = "age",values_from = met)
rhomat <-rhomat %>% remove_rownames %>% column_to_rownames(var="time_step")
rhomat <-as.matrix(rhomat)

#as contour plot
fig2 <-plot_ly(type="contour",contours = list(showlabels = TRUE),
               colorscale='Jet',reversescale =T,
               autocontour = F, contours = list(start = -1.2, end = 1.0,size = 0.2),
               x=~rownames(rhomat), y=~colnames(rhomat), z=~t(rhomat))%>%
      colorbar(title=metname)%>%
      layout(xaxis = list(title = 'years included'),
                                     yaxis = list(title = 'number age classes included'),
                                     #zaxis = list(title = 'r-squared',nticks=10, range=c(0,1)))) 
                                     zaxis = list(title = metname))   
fig2  
```


**Dynamic correlation**
```{r}
#preylist <-read.csv("preylists2sppXXL.csv",header=T)%>%filter(index==1)%>%dplyr::select(-X, -recnoise1,-recnoise2)
preylist <-read.csv("preylists2sppMED.csv",header=T)%>%filter(index==1)%>%dplyr::select(-X, -recnoise1,-recnoise2)
#preylist <-read.csv("preylistsOneSpp.csv",header=T)%>%filter(index==1)%>%dplyr::select(-X, -recnoise1,-recnoise2)

# scaling the data doesn't seem to change the output 
blockpiv <-filter(preylist, time_step >299 & time_step <=400)
maxE <-round(sqrt(100))
vars = unique(blockpiv$age_class)
var_pairs = combn(vars, 2) # Combinations of vars, 2 at a time
rho_matrix2spp = array(NA, dim = c(length(vars), length(vars)), dimnames = list(vars,vars)) 
for (i in 1:ncol(var_pairs)) {
  df = filter(blockpiv, age_class %in% c(var_pairs[1,i], var_pairs[2,i]))
  fitSB <-fitGP(data = df, yd = "value", pop="age_class",scaling = "local", E=maxE, tau=1, predictmethod = "loo")
  fitSB_rho <-tail(fitSB$pars,1)
  rho_matrix2spp[var_pairs[1,i], var_pairs[2,i]] = fitSB_rho
}

corrplot(rho_matrix2spp, method="color", type="upper", diag=FALSE, is.corr = TRUE)

blockpiv%>%
  ggplot(aes(time_step, value))+
  geom_line()+facet_wrap(~age_class)+theme_classic()



```




